<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrade Ultimate - Gerçek Veri & Backtest</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-dark: #131722;
            --bg-panel: #1e222d;
            --border: #2a2e39;
            --text-main: #d1d4dc;
            --text-dim: #787b86;
            --accent: #2962ff;
            --green: #089981;
            --red: #f23645;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: var(--font); height: 100vh; display: flex; overflow: hidden; font-size: 13px; }

        /* SIDEBAR */
        aside { width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; z-index: 2; }
        .header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .header span { color: var(--accent); }
        
        .section { padding: 15px; border-bottom: 1px solid var(--border); }
        .sec-title { margin: 0 0 10px 0; font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        
        label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-dim); }
        select, input { width: 100%; background: #2a2e39; border: 1px solid #363a45; color: var(--text-main); padding: 8px; border-radius: 4px; margin-bottom: 10px; transition: 0.2s; }
        select:focus, input:focus { border-color: var(--accent); }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; margin-top: 5px; }
        .btn-run { background: var(--accent); color: white; }
        .btn-run:hover { background: #1e54e6; }
        .btn-opt { background: linear-gradient(135deg, #673ab7, #512da8); color: white; }
        .btn-opt:hover { opacity: 0.9; }

        /* PROGRESS BAR */
        #opt-progress { display: none; margin-top: 10px; }
        progress { width: 100%; height: 6px; border-radius: 3px; }
        .status-text { text-align: center; font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }

        /* MAIN CONTENT */
        main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        
        #chart-wrap { flex: 2; position: relative; width: 100%; border-bottom: 1px solid var(--border); }
        #chart { width: 100%; height: 100%; }

        /* STATS BAR */
        .stats { height: 60px; background: var(--bg-panel); display: flex; align-items: center; justify-content: space-around; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); }
        .stat-val { font-size: 1.1rem; font-weight: 700; }
        .green { color: var(--green); } .red { color: var(--red); }

        /* HISTORY TABLE */
        #history { flex: 1; background: var(--bg-dark); display: flex; flex-direction: column; min-height: 0; }
        .h-header { padding: 8px 15px; background: var(--bg-panel); border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }
        .table-wrap { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { position: sticky; top: 0; background: var(--bg-panel); text-align: left; padding: 8px 15px; color: var(--text-dim); font-weight: 600; z-index: 1; }
        td { padding: 6px 15px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tr:hover { background: #2a2e39; }
        
        .badge { padding: 2px 6px; border-radius: 3px; font-weight: 700; font-size: 0.7rem; }
        .b-long { background: rgba(8, 153, 129, 0.2); color: var(--green); }
        .b-short { background: rgba(242, 54, 69, 0.2); color: var(--red); }

        /* LOADING */
        #loader { position: absolute; inset: 0; background: rgba(19, 23, 34, 0.9); z-index: 99; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<aside>
    <div class="header">ProTrade <span>Ultimate</span></div>
    
    <div class="section">
        <div class="sec-title">Veri Kaynağı</div>
        <label>Piyasa</label>
        <select id="market">
            <option value="CRYPTO">Kripto (Binance)</option>
            <option value="BIST">Borsa İstanbul (Yahoo Proxy)</option>
            <option value="US">ABD Borsası (Yahoo Proxy)</option>
            <option value="COMMODITY">Emtia (Yahoo Proxy)</option>
        </select>
        
        <label>Enstrüman</label>
        <select id="symbol"></select>
        
        <div class="row">
            <div>
                <label>Periyot</label>
                <select id="interval">
                    <option value="15m">15 Dk</option>
                    <option value="1h">1 Saat</option>
                    <option value="4h" selected>4 Saat</option>
                    <option value="1d">1 Gün</option>
                </select>
            </div>
            <div>
                <label>Oto Yenile</label>
                <select id="refresh">
                    <option value="0">Kapalı</option>
                    <option value="5000" selected>5 Sn</option>
                    <option value="10000">10 Sn</option>
                    <option value="30000">30 Sn</option>
                </select>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="sec-title">Strateji</div>
        <label>Algoritma</label>
        <select id="strategy">
            <option value="supertrend">SuperTrend</option>
            <option value="turtle">Turtle Trading</option>
            <option value="rsi">RSI Reversal</option>
            <option value="macd">MACD Momentum</option>
            <option value="bollinger">Bollinger Bands</option>
        </select>
        
        <div id="params"></div>
    </div>

    <div class="section">
        <div class="sec-title">Backtest</div>
        <label>Bakiye ($)</label>
        <input type="number" id="balance" value="1000">
        
        <button class="btn-run" onclick="App.run()">Yenile / Hesapla</button>
        <button class="btn-opt" onclick="Optimizer.run()" style="margin-top:10px;">⚡ Otomatik Optimize Et</button>
        
        <div id="opt-progress">
            <progress id="p-bar" value="0" max="100"></progress>
            <div id="p-text" class="status-text">Bekleniyor...</div>
        </div>
    </div>
</aside>

<main>
    <div id="loader"><div class="spinner"></div><div style="margin-top:10px;">Veriler Çekiliyor...</div></div>
    
    <div id="chart-wrap"><div id="chart"></div></div>
    
    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">Toplam Varlık</div>
            <div class="stat-val" id="res-bal">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Net PnL</div>
            <div class="stat-val" id="res-pnl">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Win Rate</div>
            <div class="stat-val" id="res-win">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">İşlem</div>
            <div class="stat-val" id="res-trades">---</div>
        </div>
    </div>

    <div id="history">
        <div class="h-header">
            <span>İşlem Geçmişi</span>
            <span style="opacity:0.6; font-weight:400;">Son Sinyaller</span>
        </div>
        <div class="table-wrap">
            <table id="t-history">
                <thead>
                    <tr>
                        <th>Yön</th>
                        <th>Giriş</th>
                        <th>Fiyat</th>
                        <th>Çıkış</th>
                        <th>Fiyat</th>
                        <th>Kâr/Zarar</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<script>
/* --- CONFIG & ASSETS --- */
const ASSETS = {
    CRYPTO: [
        {s:'BTCUSDT', n:'Bitcoin'}, {s:'ETHUSDT', n:'Ethereum'}, {s:'SOLUSDT', n:'Solana'}, 
        {s:'XRPUSDT', n:'Ripple'}, {s:'AVAXUSDT', n:'Avalanche'}, {s:'DOGEUSDT', n:'Dogecoin'}
    ],
    // Yahoo Symbols (using Proxy)
    BIST: [
        {s:'THYAO.IS', n:'Türk Hava Yolları'}, {s:'ASELS.IS', n:'Aselsan'}, {s:'GARAN.IS', n:'Garanti BBVA'},
        {s:'AKBNK.IS', n:'Akbank'}, {s:'EREGL.IS', n:'Ereğli Demir Çelik'}, {s:'SISE.IS', n:'Şişecam'},
        {s:'KCHOL.IS', n:'Koç Holding'}, {s:'BIMAS.IS', n:'BİM Mağazalar'}, {s:'SASA.IS', n:'SASA Polyester'}
    ],
    US: [
        {s:'AAPL', n:'Apple'}, {s:'MSFT', n:'Microsoft'}, {s:'NVDA', n:'Nvidia'}, {s:'TSLA', n:'Tesla'},
        {s:'AMZN', n:'Amazon'}, {s:'GOOGL', n:'Google'}, {s:'META', n:'Meta'}, {s:'AMD', n:'AMD'}
    ],
    COMMODITY: [
        {s:'GC=F', n:'Gold Futures'}, {s:'SI=F', n:'Silver Futures'}, {s:'CL=F', n:'Crude Oil'}, 
        {s:'NG=F', n:'Natural Gas'}, {s:'HG=F', n:'Copper'}
    ]
};

const PROXY_URL = 'https://api.allorigins.win/get?url=';

/* --- INDICATORS --- */
const Indicators = {
    // 1. Corrected SuperTrend Logic
    superTrend: (data, period, factor) => {
        let st = [];
        // ATR Calc
        let tr = [0];
        for(let i=1; i<data.length; i++) {
            let hl = data[i].high - data[i].low;
            let hc = Math.abs(data[i].high - data[i-1].close);
            let lc = Math.abs(data[i].low - data[i-1].close);
            tr.push(Math.max(hl, hc, lc));
        }
        let atr = new Array(data.length).fill(0);
        let sum=0; for(let i=0;i<period;i++) sum+=tr[i];
        atr[period-1] = sum/period;
        for(let i=period; i<data.length; i++) atr[i] = (atr[i-1]*(period-1)+tr[i])/period;

        let upper, lower, trend = 1; // 1: Long, -1: Short
        
        for(let i=0; i<data.length; i++) {
            if(i<period) { st.push({trend:1, signal:null}); continue; }
            
            let hl2 = (data[i].high + data[i].low)/2;
            let bu = hl2 + factor * atr[i];
            let bl = hl2 - factor * atr[i];
            
            let prevU = st[i-1].upper !== undefined ? st[i-1].upper : bu;
            let prevL = st[i-1].lower !== undefined ? st[i-1].lower : bl;
            let prevC = data[i-1].close;
            let prevT = st[i-1].trend;

            let finalU = (bu < prevU || prevC > prevU) ? bu : prevU;
            let finalL = (bl > prevL || prevC < prevL) ? bl : prevL;

            if(prevT === 1 && data[i].close < finalL) trend = -1;
            else if(prevT === -1 && data[i].close > finalU) trend = 1;
            else trend = prevT;

            let signal = null;
            if(trend === 1 && prevT === -1) signal = 'LONG';
            if(trend === -1 && prevT === 1) signal = 'SHORT';

            st.push({ trend, upper: finalU, lower: finalL, signal });
        }
        return st;
    },

    turtle: (data, entry, exit) => {
        let res = [];
        for(let i=0; i<data.length; i++) {
            if(i < entry) { res.push({signal:null}); continue; }
            let high = Math.max(...data.slice(i-entry, i).map(d=>d.high));
            let low = Math.min(...data.slice(i-entry, i).map(d=>d.low));
            
            let sig = null;
            if(data[i].close > high) sig = 'LONG';
            else if(data[i].close < low) sig = 'SHORT';
            res.push({signal: sig});
        }
        return res;
    },

    rsi: (data, len) => {
        let r = [];
        let gain=0, loss=0;
        for(let i=0; i<data.length; i++) {
            if(i===0) { r.push(50); continue; }
            let chg = data[i].close - data[i-1].close;
            let g = chg>0?chg:0; let l = chg<0?-chg:0;
            if(i<len) { gain+=g; loss+=l; r.push(50); }
            else if(i===len) { gain/=len; loss/=len; r.push(100-(100/(1+gain/loss))); }
            else { 
                gain=(gain*(len-1)+g)/len; 
                loss=(loss*(len-1)+l)/len; 
                r.push(100-(100/(1+gain/loss))); 
            }
        }
        return r;
    },

    macd: (data, f, s, sig) => {
        const ema = (d, p) => {
            let res=[], k=2/(p+1), e=d[0].close;
            d.forEach(x=>{e=x.close*k+e*(1-k); res.push(e)});
            return res;
        };
        let ef = ema(data, f), es = ema(data, s);
        let macd = ef.map((v,i)=>v-es[i]);
        let sign = [], k=2/(sig+1), e=macd[0];
        macd.forEach(v=>{e=v*k+e*(1-k); sign.push(e)});
        return {macd, signal: sign};
    },

    bollinger: (data, p, std) => {
        let res = [];
        for(let i=0; i<data.length; i++) {
            if(i<p) { res.push({upper:0, lower:0}); continue; }
            let sl = data.slice(i-p+1, i+1);
            let avg = sl.reduce((a,b)=>a+b.close,0)/p;
            let dev = Math.sqrt(sl.reduce((a,b)=>a+Math.pow(b.close-avg,2),0)/p);
            res.push({upper: avg+dev*std, lower: avg-dev*std});
        }
        return res;
    }
};

/* --- APP CONTROLLER --- */
const App = {
    chart: null, candleSeries: null, volSeries: null,
    data: [], intervalId: null,

    paramsDef: {
        supertrend: [{id:'st_p',l:'Periyot',v:10},{id:'st_f',l:'Faktör',v:3,s:0.1}],
        turtle: [{id:'tt_in',l:'Giriş',v:20},{id:'tt_out',l:'Çıkış',v:10}],
        rsi: [{id:'rsi_l',l:'Uzunluk',v:14},{id:'rsi_ob',l:'Üst',v:70},{id:'rsi_os',l:'Alt',v:30}],
        macd: [{id:'m_f',l:'Fast',v:12},{id:'m_s',l:'Slow',v:26},{id:'m_sg',l:'Sig',v:9}],
        bollinger: [{id:'bb_p',l:'Periyot',v:20},{id:'bb_s',l:'Std',v:2}]
    },

    init: () => {
        // Chart Setup
        const cont = document.getElementById('chart');
        App.chart = LightweightCharts.createChart(cont, {
            layout: { background: { color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
            timeScale: { borderColor: '#2a2e39', timeVisible:true },
            rightPriceScale: { borderColor: '#2a2e39', scaleMargins: { top: 0.1, bottom: 0.25 } } // FIX: Volume overlap prevention
        });

        // Volume Series (Bottom 20%)
        App.volSeries = App.chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: '', 
            scaleMargins: { top: 0.8, bottom: 0 }
        });

        // Candle Series
        App.candleSeries = App.chart.addCandlestickSeries({
            upColor: '#089981', downColor: '#f23645',
            borderVisible: false, wickUpColor: '#089981', wickDownColor: '#f23645'
        });

        new ResizeObserver(()=>App.chart.resize(cont.clientWidth, cont.clientHeight)).observe(cont);

        // Events
        document.getElementById('market').addEventListener('change', App.loadSymbols);
        document.getElementById('strategy').addEventListener('change', App.renderParams);
        document.getElementById('refresh').addEventListener('change', App.setRefresh);
        
        App.loadSymbols();
        App.renderParams();
        App.setRefresh(); // Start with default
        App.run();
    },

    loadSymbols: () => {
        const m = document.getElementById('market').value;
        const s = document.getElementById('symbol');
        s.innerHTML = '';
        ASSETS[m].forEach(x => {
            let o = document.createElement('option');
            o.value = x.s; o.text = x.n + ` (${x.s})`;
            s.add(o);
        });
    },

    renderParams: () => {
        const s = document.getElementById('strategy').value;
        const div = document.getElementById('params');
        div.innerHTML = '';
        App.paramsDef[s].forEach(p => {
            div.innerHTML += `
                <div style="margin-bottom:8px">
                    <label>${p.l}</label>
                    <input type="number" id="${p.id}" value="${p.v}" step="${p.s||1}">
                </div>`;
        });
    },

    setRefresh: () => {
        if(App.intervalId) clearInterval(App.intervalId);
        const ms = parseInt(document.getElementById('refresh').value);
        if(ms > 0) App.intervalId = setInterval(()=>App.run(true), ms);
    },

    // REAL DATA FETCHING (Yahoo Proxy + Binance)
    fetchData: async () => {
        const m = document.getElementById('market').value;
        const sym = document.getElementById('symbol').value;
        const tf = document.getElementById('interval').value;
        
        let data = [];
        
        try {
            if(m === 'CRYPTO') {
                // Binance API (Direct)
                const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=500`);
                const j = await r.json();
                data = j.map(d=>({
                    time: d[0]/1000, open:+d[1], high:+d[2], low:+d[3], close:+d[4], value:+d[5],
                    color: (+d[4]>+d[1]) ? 'rgba(8, 153, 129, 0.4)' : 'rgba(242, 54, 69, 0.4)'
                }));
            } else {
                // Yahoo Finance via Proxy
                // Mapping Interval: 15m->15m, 1h->60m, 4h->1h(failover) or 1d->1d
                // Yahoo API intervals: 1m, 2m, 5m, 15m, 30m, 60m, 90m, 1h, 1d, 5d, 1wk, 1mo, 3mo
                let yTf = '1d'; let range = '2y';
                if(tf==='15m') { yTf='15m'; range='1mo'; }
                if(tf==='1h') { yTf='60m'; range='3mo'; }
                if(tf==='4h') { yTf='60m'; range='6mo'; } // Yahoo doesn't support 4h well, using 1h
                
                const url = encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=${yTf}&range=${range}`);
                const r = await fetch(PROXY_URL + url);
                const raw = await r.json();
                const contents = JSON.parse(raw.contents); // AllOrigins wraps response
                
                const res = contents.chart.result[0];
                const quote = res.indicators.quote[0];
                const times = res.timestamp;
                
                for(let i=0; i<times.length; i++) {
                    if(quote.open[i] === null) continue;
                    let c = quote.close[i]; let o = quote.open[i];
                    data.push({
                        time: times[i],
                        open: o, high: quote.high[i], low: quote.low[i], close: c,
                        value: quote.volume[i] || 0,
                        color: (c>=o) ? 'rgba(8, 153, 129, 0.4)' : 'rgba(242, 54, 69, 0.4)'
                    });
                }
            }
        } catch(e) {
            console.error("Data Fetch Error:", e);
            // Fallback to Simulation if Proxy fails
            return App.generateSim(sym);
        }
        return data;
    },

    generateSim: (seed) => {
        // Fallback generator
        let d = []; let t = Math.floor(Date.now()/1000)-500*3600; let p = 100;
        for(let i=0;i<500;i++) {
            let m = (Math.sin(i+seed.length)*2); 
            let c=p+m; let o=p; 
            d.push({time:t, open:o, high:Math.max(o,c)+1, low:Math.min(o,c)-1, close:c, value:1000, color:'rgba(8,153,129,0.4)'});
            p=c; t+=3600;
        }
        return d;
    },

    run: async (silent=false) => {
        if(!silent) document.getElementById('loader').style.display = 'flex';
        
        const data = await App.fetchData();
        if(!data.length) { if(!silent) alert("Veri alınamadı (Proxy Hatası)"); document.getElementById('loader').style.display='none'; return; }
        
        App.data = data;
        
        // Run Strategy
        const strat = document.getElementById('strategy').value;
        const pVals = {};
        App.paramsDef[strat].forEach(p => pVals[p.id] = parseFloat(document.getElementById(p.id).value));
        
        const res = Backtest.calc(data, strat, pVals);
        
        // Update Chart
        App.candleSeries.setData(data);
        App.volSeries.setData(data.map(d=>({time:d.time, value:d.value, color:d.color})));
        App.candleSeries.setMarkers(res.markers);
        
        if(!silent) App.chart.timeScale().fitContent();
        
        // Update Stats
        const bal = parseFloat(document.getElementById('balance').value);
        const profit = res.pnl;
        const final = bal + profit;
        
        document.getElementById('res-bal').innerText = '$' + final.toFixed(2);
        document.getElementById('res-pnl').innerHTML = `<span class="${profit>=0?'green':'red'}">${profit>=0?'+':''}${profit.toFixed(2)}</span>`;
        document.getElementById('res-win').innerText = '%' + res.winRate;
        document.getElementById('res-trades').innerText = res.trades.length;
        
        App.renderHistory(res.trades);
        
        if(!silent) document.getElementById('loader').style.display = 'none';
    },

    renderHistory: (trades) => {
        const b = document.querySelector('#t-history tbody');
        b.innerHTML = '';
        [...trades].reverse().forEach(t => {
            const row = `
                <tr>
                    <td><span class="badge ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span></td>
                    <td>${new Date(t.entryT*1000).toLocaleDateString()}</td>
                    <td>${t.entryP.toFixed(2)}</td>
                    <td>${new Date(t.exitT*1000).toLocaleDateString()}</td>
                    <td>${t.exitP.toFixed(2)}</td>
                    <td class="${t.pnl>=0?'green':'red'}">${t.pnl.toFixed(2)}</td>
                </tr>`;
            b.innerHTML += row;
        });
    }
};

/* --- BACKTEST ENGINE --- */
const Backtest = {
    calc: (data, strat, p) => {
        let signals = [];
        // Generate Signals
        if(strat==='supertrend') {
            const st = Indicators.superTrend(data, p.st_p, p.st_f);
            signals = st.map(x=>x.signal);
        } else if(strat==='turtle') {
            const t = Indicators.turtle(data, p.tt_in, p.tt_out);
            signals = t.map(x=>x.signal);
        } else if(strat==='rsi') {
            const r = Indicators.rsi(data, p.rsi_l);
            for(let i=1;i<data.length;i++){
                if(r[i-1]<p.rsi_os && r[i]>=p.rsi_os) signals[i]='LONG';
                else if(r[i-1]>p.rsi_ob && r[i]<=p.rsi_ob) signals[i]='SHORT';
                else signals[i]=null;
            }
        } else if(strat==='macd') {
            const m = Indicators.macd(data, p.m_f, p.m_s, p.m_sg);
            for(let i=1;i<data.length;i++){
                if(m.macd[i-1]<m.signal[i-1] && m.macd[i]>m.signal[i]) signals[i]='LONG';
                else if(m.macd[i-1]>m.signal[i-1] && m.macd[i]<m.signal[i]) signals[i]='SHORT';
                else signals[i]=null;
            }
        } else if(strat==='bollinger') {
            const bb = Indicators.bollinger(data, p.bb_p, p.bb_s);
            for(let i=1;i<data.length;i++){
                if(data[i].close<bb[i].lower) signals[i]='LONG';
                else if(data[i].close>bb[i].upper) signals[i]='SHORT';
                else signals[i]=null;
            }
        }

        // Sim Trades
        let pos = null;
        let trades = [];
        let markers = [];
        let balance = parseFloat(document.getElementById('balance').value);
        let startBal = balance;
        let wins = 0;

        for(let i=1; i<data.length; i++) {
            const sig = signals[i];
            const price = data[i].close;
            const time = data[i].time;

            if(pos) {
                // Exit Logic
                if((pos.type==='LONG' && sig==='SHORT') || (pos.type==='SHORT' && sig==='LONG')) {
                    const pnl = (pos.type==='LONG' ? price - pos.p : pos.p - price) * pos.amt;
                    trades.push({type:pos.type, entryT:pos.t, entryP:pos.p, exitT:time, exitP:price, pnl:pnl});
                    if(pnl>0) wins++;
                    markers.push({time:time, position:pos.type==='LONG'?'aboveBar':'belowBar', color:'#d1d4dc', shape:'circle', text:'Exit', id:`e${i}`}); // Fix: ID added
                    pos = null;
                }
            }

            if(!pos && sig) {
                pos = { type:sig, p:price, t:time, amt: balance/price };
                markers.push({
                    time:time, 
                    position: sig==='LONG'?'belowBar':'aboveBar', // Fix: Visual Placement
                    color: sig==='LONG'?'#089981':'#f23645', 
                    shape: sig==='LONG'?'arrowUp':'arrowDown', 
                    text: sig,
                    id: `s${i}`
                });
            }
        }

        const totalPnl = trades.reduce((a,b)=>a+b.pnl, 0);
        return {
            pnl: totalPnl,
            winRate: trades.length ? Math.round((wins/trades.length)*100) : 0,
            trades: trades,
            markers: markers
        };
    }
};

/* --- OPTIMIZER --- */
const Optimizer = {
    run: async () => {
        const strat = document.getElementById('strategy').value;
        const data = App.data;
        if(!data.length) return;

        const pBar = document.getElementById('p-bar');
        const pText = document.getElementById('p-text');
        document.getElementById('opt-progress').style.display='block';

        let vars = [];
        // Define Search Space
        if(strat==='supertrend') for(let p=7;p<20;p+=3) for(let f=1;f<5;f+=1) vars.push({st_p:p, st_f:f});
        if(strat==='turtle') for(let i=10;i<50;i+=10) for(let o=5;o<25;o+=5) if(i>o) vars.push({tt_in:i, tt_out:o});
        if(strat==='rsi') for(let l=7;l<21;l+=2) for(let ob=60;ob<90;ob+=10) vars.push({rsi_l:l, rsi_ob:ob, rsi_os:100-ob});
        // (Add others as needed)

        let best = -Infinity; let bestP = null;
        
        for(let i=0; i<vars.length; i++) {
            if(i%5===0) { pBar.value = (i/vars.length)*100; pText.innerText=`Deneme ${i}/${vars.length}`; await new Promise(r=>setTimeout(r,0)); }
            const res = Backtest.calc(data, strat, vars[i]);
            if(res.pnl > best) { best = res.pnl; bestP = vars[i]; }
        }

        if(bestP) {
            for(let k in bestP) document.getElementById(k).value = bestP[k];
            pText.innerText = `Bitti! Max PnL: $${best.toFixed(2)}`;
            App.run();
        }
    }
};

// Start
App.init();

</script>
</body>
</html>