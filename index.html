<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ProTrade AI V23 - Update Crypto List</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --border: #30363d;
            --text-main: #e6edf3;
            --text-dim: #848d97;
            --accent: #2f81f7;
            --green: #089981;
            --red: #f23645;
            --rsi-color: #a371f7;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: var(--font); height: 100vh; display: flex; overflow: hidden; font-size: 13px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        aside { width: 360px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; transition: transform 0.3s ease; }
        
        .header { position: relative; padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); background: #0d1117; }
        .header-title { display: flex; align-items: center; gap: 10px; }
        .header span { color: var(--accent); }
        
        /* Live Indicator */
        .live-status { width: 10px; height: 10px; border-radius: 50%; background: #444; box-shadow: 0 0 5px #444; transition: 0.3s; margin-left: 8px; }
        .live-status.on { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .sidebar-tabs { display: flex; background: #0d1117; border-bottom: 1px solid var(--border); overflow: hidden; }
        .st-tab { flex: 1; text-align: center; padding: 12px 5px; cursor: pointer; color: var(--text-dim); font-weight: 600; border-bottom: 2px solid transparent; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.8rem; }
        .st-tab:hover { background: #1c2128; }
        .st-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: var(--bg-panel); }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .sidebar-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .sec-title { margin: 0 0 10px 0; font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-main); }
        select, input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: var(--text-main); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-family: var(--font); font-size: 0.85rem; }
        select:focus, input:focus { border-color: var(--accent); }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        button { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px; transition: 0.2s; }
        .btn-run { background: var(--accent); color: white; }
        .btn-run:hover { background: #58a6ff; }
        .btn-next { background: #1f6feb; color: white; margin-top: 15px; } 
        .btn-opt { background: linear-gradient(135deg, #238636, #2ea043); color: white; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-scan { background: linear-gradient(135deg, #8e44ad, #673ab7); color: white; margin-top: 10px; box-shadow: 0 4px 10px rgba(142,68,173,0.3); }
        .btn-blue-std { background: #1f6feb; color: white; font-size: 0.8rem; padding: 10px; text-align: center; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 100%; margin: 0; }

        .tp-sl-box { background: #1c2128; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-top: 15px; }
        .tp-sl-header, .checkbox-row { display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; min-height: 30px; }
        .tp-sl-header input[type="checkbox"], .checkbox-row input[type="checkbox"] { width: 16px; height: 16px; margin: 0; pointer-events: none; flex-shrink: 0; }
        .tp-sl-header label, .checkbox-row label { margin: 0; font-size: 0.8rem; cursor: pointer; line-height: 1.2; }
        .tp-sl-content { display: none; margin-top: 10px;}
        .tp-sl-content.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from {opacity: 0; transform: translateY(-5px);} to {opacity: 1; transform: translateY(0);} }
        .checkbox-row { margin-top: 10px; padding: 8px 12px; background: #1c2128; border-radius: 4px; border: 1px solid transparent; }
        .checkbox-row:hover { border-color: var(--border); }
        
        #cache-info, #opt-cache-info { font-size: 0.75rem; color: #8b949e; margin-top: 5px; font-style: italic; min-height: 15px; line-height: 1.4; text-align:center;}
        #opt-cache-info { color: var(--green); margin-bottom: 5px; }

        .btn-red { background: #da3633; border: 1px solid #b62324; color: white; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; margin-top: 8px; width: 100%; text-align: center; font-weight: 600; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition:0.2s; }
        .btn-red:hover { background: #b62324; }
        .d-block { display: block !important; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); }
        .modal-text { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 20px; }
        .progress-wrapper { position: relative; height: 20px; background: #0d1117; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid var(--border); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2f81f7, #238636); width: 0%; transition: width 0.1s; }
        .progress-percent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: bold; color: white; text-shadow: 0 1px 2px black; }

        main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #chart-wrap { flex: 1; position: relative; width: 100%; overflow: hidden; }
        #chart { width: 100%; height: 100%; }
        
        #chart-legend { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(13, 17, 23, 0.9); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; pointer-events: none; font-family: monospace; font-size: 0.85rem; color: var(--text-main); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .legend-row { display: flex; gap: 15px; margin-bottom: 2px; }
        .legend-val { font-weight: 700; }
        .l-up { color: var(--green); } .l-down { color: var(--red); }

        .stats { height: 60px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; flex-shrink: 0; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 3px; }
        .stat-val { font-size: 1.1rem; font-weight: 700; font-family: monospace; }
        .green { color: var(--green); } .red { color: var(--red); }

        #bottom-panel { height: 250px; background: var(--bg-dark); display: flex; flex-direction: column; border-top: 1px solid var(--border); }
        .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: var(--text-dim); border-right: 1px solid var(--border); }
        .tab.active { background: var(--bg-dark); color: var(--text-main); border-top: 2px solid var(--accent); }
        .tab-content { flex: 1; overflow: hidden; display: none; }
        .tab-content.active { display: block; }

        .table-wrap { height: 100%; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { position: sticky; top: 0; background: var(--bg-panel); text-align: left; padding: 8px 15px; color: var(--text-dim); border-bottom: 1px solid var(--border); z-index: 5; }
        td { padding: 6px 15px; border-bottom: 1px solid var(--border); color: var(--text-main); font-family: monospace; }
        tbody tr:hover { background: #1c2128; cursor: pointer; }

        .badge { padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; display: ruby-text;}
        .b-long { background: rgba(8, 153, 129, 0.15); color: #089981; border: 1px solid rgba(8, 153, 129, 0.4); }
        .b-short { background: rgba(242, 54, 69, 0.15); color: #f23645; border: 1px solid rgba(242, 54, 69, 0.4); }
        .b-open { background: rgba(56, 139, 253, 0.15); color: #58a6ff; border: 1px solid rgba(56, 139, 253, 0.4); }
        .b-neutral { background: #30363d; color: #8b949e; }

        #toast { position: absolute; top: 20px; right: 20px; background: #8b949e; color: #0d1117; padding: 12px 24px; border-radius: 6px; font-weight: 600; display: none; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        
        #trade-status-bar { height: 50px; background: #1c2128; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; display: none; }
        .ts-group { display: flex; align-items: center; gap: 15px; }
        .ts-label { font-size: 0.8rem; color: var(--text-dim); font-weight: 600; }
        .ts-val { font-family: monospace; font-size: 1rem; font-weight: 700; }
		
		#mobile-menu-btn { display: none; background: transparent; color: var(--text-main); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 20px; cursor: pointer; line-height: 1; width: auto; margin: 0; }
        #mobile-menu-btn:hover { background: #21262d; border-color: var(--accent); color: var(--accent); }

		@media (max-width: 1024px) {
			body { flex-direction: column; overflow: hidden; }
			#mobile-menu-btn { display: block; }
			aside { position: fixed; top: 0; left: -100%; width: 85%; max-width: 420px; height: 100%; z-index: 10000; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
			aside.open { left: 0; transform: none; }
			main { flex: 1; width: 100%; height: 100%; }
			#chart-wrap { height: calc(100vh - 120px); }
			.stats { height: auto; flex-wrap: wrap; padding: 10px 0; gap: 10px; }
			.stat-box { width: 45%; }
			#bottom-panel { height: 40vh; }
			.tabs { overflow-x: auto; white-space: nowrap; }
            #menu-backdrop { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9999; }
            #menu-backdrop.active { display: block; }
            #mobile-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: #0d1117; border-bottom: 1px solid var(--border); }
		}
        @media (min-width: 1025px) { #mobile-header { display: none; } }
		
		/* Mobil √úst Bar - Dinamik Ada Desteƒüi */
		#mobile-header {
			display: flex !important;
			align-items: center; 
			justify-content: space-between;
			background: #0d1117;
			border-bottom: 1px solid var(--border);
			/* ƒ∞√ßeriƒüi Dinamik Ada'nƒ±n TAMAMEN altƒ±na iter */
			padding-top: env(safe-area-inset-top) !important; 
			height: 50px; /* ƒ∞√ßerik y√ºksekliƒüi */
			box-sizing: content-box; /* Padding'i y√ºksekliƒüe ekler */
			z-index: 1000;
		}

		/* Kenar Men√º A√ßƒ±ldƒ±ƒüƒ±nda √úst Kƒ±sƒ±m */
		aside .header {
			display: flex !important;
			align-items: center;
			justify-content: space-between;
			padding-top: env(safe-area-inset-top) !important;
			height: 50px;
			box-sizing: content-box;
			background: #0d1117;
		}

		/* Grafik alanƒ±nƒ±n tepeden basƒ±k olmamasƒ± i√ßin */
		main {
			height: 100vh;
			padding-bottom: env(safe-area-inset-bottom);
		}
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">ƒ∞≈üleniyor...</div>
        <div class="progress-wrapper">
            <div class="progress-fill" id="modal-bar"></div>
            <div class="progress-percent" id="modal-percent">0%</div>
        </div>
        <div class="modal-text" id="modal-desc">L√ºtfen bekleyiniz...</div>
    </div>
</div>

<div id="menu-backdrop" onclick="App.closeMenu()"></div>

<aside>
    <div class="header">
        <div class="header-title">ProTrade <span>AI</span> <div id="live-indicator" class="live-status"></div></div>
        <button id="mobile-menu-btn" style="border:none;" onclick="App.closeMenu()" class="hide-desktop">‚úï</button>
	</div>
    
    <div class="sidebar-tabs">
        <div class="st-tab active" id="tab-head-market" onclick="App.sTab('market')">Piyasa</div>
        <div class="st-tab" id="tab-head-strat" onclick="App.sTab('strat')">Strateji</div>
        <div class="st-tab" onclick="App.sTab('system')">Backtest</div>
    </div>

    <!-- TAB: MARKET -->
    <div id="sb-market" class="sidebar-content active">
        <div class="section">
            <div class="sec-title">Veri Kaynaƒüƒ±</div>
            <label>Piyasa Se√ßimi</label>
            <select id="market">
                <option value="CRYPTO">Kripto (Binance)</option>
                <option value="BIST">Borsa ƒ∞stanbul</option>
                <option value="US">ABD Borsasƒ±</option>
                <option value="FOREX">Forex & Emtia</option>
            </select>
            
            <label>Enstr√ºman</label>
            <select id="symbol"></select>
            <div id="cache-info"></div>
            <button id="clear-cache-btn" class="btn-red" onclick="CacheDB.clear()">üóëÔ∏è T√ºm Veri √ñnbelleƒüini Temizle</button>
            <button id="btn-update-assets" class="btn-blue-std" style="margin-top:10px;" onclick="AssetManager.updateCryptoList()">üîÑ Kripto Listesini G√ºncelle</button>
            
            <div class="row" style="margin-top:15px; margin-bottom:15px;">
                <button class="btn-blue-std" onclick="AssetManager.save()">Listeyi Kaydet</button>
                <label for="asset-file" class="btn-blue-std" style="margin-top:0;">Listeyi Y√ºkle</label>
                <input type="file" id="asset-file" style="display:none" onchange="AssetManager.load(this)">
            </div>

            <div class="row">
                <div>
                    <label>Periyot</label>
                    <select id="interval">
						<option value="1m">1 Dk</option>
						<option value="5m">5 Dk</option>
                        <option value="15m">15 Dk</option>
                        <option value="1h">1 Saat</option>
                        <option value="2h">2 Saat</option>
                        <option value="4h" selected>4 Saat</option>
                        <option value="1d">1 G√ºn</option>
                    </select>
                </div>
                <div>
                    <label>Mum Sayƒ±sƒ±</label>
                    <select id="limit">
                        <option value="200">200</option>
                        <option value="500" selected>500</option>
                        <option value="1000">1000</option>
                        <option value="2000">2000</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-next" onclick="App.sTab('strat')">Algoritma Se√ß ‚û°</button>
        </div>
    </div>

    <!-- TAB: STRATEGY -->
    <div id="sb-strat" class="sidebar-content">
        <div class="section">
            <div class="sec-title">Algoritma Se√ßimi</div>
            <select id="strategy">
                <optgroup label="√ñzel Kripto Algoritmalarƒ±">
                    <option value="lsvt">LSVT (Likidasyon & Hacim)</option>
                </optgroup>
                <optgroup label="Trend Takip">
                    <option value="supertrend">SuperTrend</option>
                    <option value="emacross">EMA Cross (MA Kesi≈üimi)</option>
                    <option value="psar">Parabolic SAR</option>
                    <option value="turtle">Turtle Trading</option>
                    <option value="vwap">VWAP (Hacim Aƒüƒ±rlƒ±klƒ±)</option>
                    <option value="adx">ADX (Trend G√ºc√º)</option>
                </optgroup>
                <optgroup label="Momentum / Osilat√∂r">
                    <option value="rsi_strat">RSI (A≈üƒ±rƒ± Alƒ±m/Satƒ±m)</option>
                    <option value="macd">MACD (Trend + Momentum)</option>
                    <option value="stoch">Stochastic</option>
                    <option value="williams">Williams %R</option>
                </optgroup>
            </select>
            <div id="params"></div>
            
            <!-- TP / SL MODULE -->
            <div class="tp-sl-box">
                <div class="tp-sl-header" onclick="App.toggleTpSlManual()">
                    <input type="checkbox" id="use-tpsl">
                    <label>Kar Al / Zarar Durdur</label>
                </div>
                <div class="tp-sl-content" id="tpsl-params">
                    <div class="row">
                        <div>
                            <label>Kar Al (%)</label>
                            <input type="number" id="tp-val" value="3.0" step="0.1">
                        </div>
                        <div>
                            <label>Stop (%)</label>
                            <input type="number" id="sl-val" value="1.5" step="0.1">
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-run" onclick="App.run(); App.closeMenu();">Analiz Et</button>
        </div>
        
        <div class="section">
            <div class="sec-title">Optimizasyon</div>
            <button class="btn-opt" onclick="Optimizer.runSingle(true)">‚ö° En ƒ∞yi Parametreleri Bul</button>
            <div id="opt-cache-info"></div>
            <button id="btn-del-opt-cache" class="btn-red" onclick="Optimizer.clearCurrent()">Mevcut Ayar Cache'ini Sil</button>
            <button id="btn-del-all-opt" class="btn-red d-block" onclick="Optimizer.clearAll()">T√ºm En ƒ∞yi Parametre Cache Deƒüerlerini Sil</button>
        </div>

        <div class="section">
            <div class="sec-title">G√∂rsel ƒ∞ndikat√∂rler</div>
            <label>Grafik Altƒ± RSI Periyodu</label>
            <input type="number" id="vis-rsi-len" value="14">
        </div>
    </div>

    <!-- TAB: BACKTEST (SYSTEM) -->
    <div id="sb-system" class="sidebar-content">
        <div class="section">
            <div class="sec-title">Piyasa Tarayƒ±cƒ±</div>
            <div id="crypto-scanner-area">
                <button class="btn-scan" id="scan-btn" onclick="Scanner.start(); App.closeMenu();">üöÄ T√úM Pƒ∞YASAYI TARA</button>
                
                <div class="checkbox-row" onclick="App.toggleScanOpt()">
                    <input type="checkbox" id="scan-tpsl-opt">
                    <label>TP/SL Dahil Optimize Et</label>
                </div>

                <div style="text-align:center; font-size:0.7rem; color:#8b949e; margin-top:10px;" id="last-scan-time"></div>
            </div>
        </div>

        <div class="section">
            <div class="sec-title">Sermaye Y√∂netimi</div>
            <label>Bakiye ($)</label>
            <input type="number" id="balance" value="1000">
        </div>

        <div class="section">
            <div class="sec-title">Veri Y√∂netimi</div>
            <div class="row">
                <button class="btn-blue-std" onclick="ConfigManager.save()">üì• Tarama Verilerini ƒ∞ndir</button>
                <label for="file-input" class="btn-blue-std" style="margin-top:0;">üì§ Veri Geri Y√ºkle</label>
                <input type="file" id="file-input" style="display:none" onchange="ConfigManager.load(this)">
            </div>
        </div>
    </div>
</aside>

<main>
    <div id="mobile-header">
        <button id="mobile-menu-btn" onclick="App.openMenu()">‚ò∞</button>
        <div style="font-weight:700; color:var(--text-main);">ProTrade <span style="color:var(--accent);">AI</span></div>
        <div style="width:30px;"></div>
    </div>

    <div id="toast"></div>

    <div id="trade-status-bar">
        <div class="ts-group">
            <span class="badge b-open" id="at-type">LONG</span>
            <div><div class="ts-label">Giri≈ü</div><div class="ts-val" id="at-entry">0.00</div></div>
            <div><div class="ts-label">Anlƒ±k</div><div class="ts-val" id="at-curr">0.00</div></div>
        </div>
        <div class="ts-group">
            <div style="text-align:right"><div class="ts-label">Anlƒ±k K√¢r/Zarar</div><div class="ts-val" id="at-pnl">0.00 $</div></div>
        </div>
    </div>

    <div id="chart-wrap">
        <div id="chart-legend">
            <div class="legend-row">
                <span class="legend-label">O:</span><span class="legend-val" id="leg-o">--</span>
                <span class="legend-label">H:</span><span class="legend-val" id="leg-h">--</span>
                <span class="legend-label">L:</span><span class="legend-val" id="leg-l">--</span>
                <span class="legend-label">C:</span><span class="legend-val" id="leg-c">--</span>
            </div>
            <div class="legend-row">
                <span class="legend-label">Vol:</span><span class="legend-val" id="leg-v">--</span>
                <span class="legend-label" style="margin-left:10px; color:var(--rsi-color)">RSI:</span><span class="legend-val" id="leg-rsi">--</span>
            </div>
        </div>
        <div id="chart"></div>
    </div>
    
    <div class="stats">
        <div class="stat-box"><div class="stat-label">Toplam Varlƒ±k</div><div class="stat-val" id="res-bal">---</div></div>
        <div class="stat-box"><div class="stat-label">Toplam PnL</div><div class="stat-val" id="res-pnl">---</div></div>
        <div class="stat-box"><div class="stat-label">Ba≈üarƒ± %</div><div class="stat-val" id="res-win">---</div></div>
        <div class="stat-box"><div class="stat-label">ƒ∞≈ülem Adedi</div><div class="stat-val" id="res-trades">---</div></div>
    </div>

    <div id="bottom-panel">
        <div class="tabs">
            <div class="tab active" onclick="App.switchTab('history')">ƒ∞≈ülem Ge√ßmi≈üi</div>
            <div class="tab" onclick="App.switchTab('scanner')">üîç Tarama Sonu√ßlarƒ±</div>
        </div>
        <div id="tab-history" class="tab-content active">
            <div class="table-wrap">
                <table id="t-history">
                    <thead><tr><th>Tip</th><th>Giri≈ü</th><th>Fiyat</th><th>√áƒ±kƒ±≈ü</th><th>Fiyat</th><th>PnL</th><th>Neden</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="tab-scanner" class="tab-content">
            <div class="table-wrap">
                <table id="t-scanner">
                    <thead><tr><th>Sembol</th><th>Son ƒ∞≈ülem</th><th>Sinyal</th><th>PnL ($)</th><th>Win Rate</th><th>ƒ∞≈ülem</th><th>Durum</th></tr></thead>
                    <tbody><tr><td colspan="7" style="text-align:center; padding:20px; color:#8b949e;">Tarama yapƒ±lmadƒ± veya veri y√ºklenmedi.</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
const DB_VERSION = 2; // ** VERSION UPGRADED TO FIX DB ISSUE **

/* --- 0. CACHE DATABASE --- */
const CacheDB = {
    dbName: 'ProTradeDB_V3', version: 3, db: null,
    open: () => {
        return new Promise((resolve, reject) => {
            if(CacheDB.db) return resolve(CacheDB.db);
            const request = indexedDB.open(CacheDB.dbName, CacheDB.version);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('candles')) db.createObjectStore('candles'); 
                if(!db.objectStoreNames.contains('optimizations')) db.createObjectStore('optimizations'); 
                if(!db.objectStoreNames.contains('assets')) db.createObjectStore('assets'); 
                if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta'); 
            };
            request.onsuccess = (e) => { CacheDB.db = e.target.result; resolve(CacheDB.db); };
            request.onerror = (e) => reject(e);
        });
    },
    get: async (storeName, key) => {
        const db = await CacheDB.open();
        return new Promise((resolve) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => resolve(null);
        });
    },
    put: async (storeName, key, data) => {
        const db = await CacheDB.open();
        return new Promise((resolve) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            store.put(data, key);
            tx.oncomplete = () => resolve();
        });
    },
    delete: async (storeName, key) => {
        const db = await CacheDB.open();
        return new Promise((resolve) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            store.delete(key);
            tx.oncomplete = () => resolve();
        });
    },
    clearStore: async (storeName) => {
        const db = await CacheDB.open();
        return new Promise((resolve) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const countReq = store.count();
            countReq.onsuccess = () => {
                const count = countReq.result;
                store.clear();
                tx.oncomplete = () => resolve(count);
            };
        });
    },
    clear: async () => { 
        const count = await CacheDB.clearStore('candles');
        App.toast(`${count} adet veri √∂nbelleƒüi temizlendi.`, 'green');
        document.getElementById('cache-info').innerText = '';
        document.getElementById('clear-cache-btn').style.display = 'none';
    },
    wipeAll: async () => {
        return new Promise((resolve, reject) => {
            if(CacheDB.db) {
                CacheDB.db.close();
                CacheDB.db = null; // ** CRITICAL FIX: Reset the handle so next open() works **
            }
            const req = indexedDB.deleteDatabase(CacheDB.dbName);
            req.onsuccess = () => {
                CacheDB.db = null; // Ensure it's null
                resolve();
            };
            req.onerror = () => reject();
        });
    }
};

/* --- 1. DATA CONFIG --- */
let ASSETS = {
    CRYPTO: [], // Dynamically filled
    BIST: [{s:'THYAO.IS',n:'THY'},{s:'ASELS.IS',n:'Aselsan'},{s:'GARAN.IS',n:'Garanti'},{s:'AKBNK.IS',n:'Akbank'},{s:'SISE.IS',n:'≈ûi≈üecam'},{s:'KCHOL.IS',n:'Ko√ß'},{s:'SAHOL.IS',n:'Sabancƒ±'},{s:'EREGL.IS',n:'Ereƒüli'},{s:'TUPRS.IS',n:'T√ºpra≈ü'},{s:'BIMAS.IS',n:'Bƒ∞M'},{s:'ISCTR.IS',n:'ƒ∞≈ü Bankasƒ±'},{s:'YKBNK.IS',n:'Yapƒ± Kredi'},{s:'FROTO.IS',n:'Ford Otosan'},{s:'TOASO.IS',n:'Tofa≈ü'},{s:'TCELL.IS',n:'Turkcell'},{s:'SASA.IS',n:'SASA'},{s:'HEKTS.IS',n:'Hekta≈ü'},{s:'PETKM.IS',n:'Petkim'},{s:'EKGYO.IS',n:'Emlak Konut'},{s:'ODAS.IS',n:'Oda≈ü'},{s:'KOZAL.IS',n:'Koza'},{s:'KRDMD.IS',n:'Kardemir D'},{s:'ASTOR.IS',n:'Astor'},{s:'ENKAI.IS',n:'Enka'},{s:'ALARK.IS',n:'Alarko'},{s:'GUBRF.IS',n:'G√ºbre Fab.'},{s:'VESTL.IS',n:'Vestel'},{s:'ARCLK.IS',n:'Ar√ßelik'}],
    US: [{s:'AAPL',n:'Apple'},{s:'MSFT',n:'Microsoft'},{s:'NVDA',n:'Nvidia'},{s:'TSLA',n:'Tesla'},{s:'AMZN',n:'Amazon'},{s:'GOOGL',n:'Google'},{s:'META',n:'Meta'},{s:'AMD',n:'AMD'},{s:'NFLX',n:'Netflix'},{s:'INTC',n:'Intel'},{s:'BABA',n:'Alibaba'},{s:'PYPL',n:'PayPal'},{s:'CRM',n:'Salesforce'},{s:'ADBE',n:'Adobe'},{s:'CSCO',n:'Cisco'},{s:'JPM',n:'JPMorgan'},{s:'V',n:'Visa'},{s:'WMT',n:'Walmart'},{s:'PG',n:'Procter & Gamble'},{s:'XOM',n:'Exxon Mobil'}],
    FOREX: [{s:'EURUSD=X',n:'EUR/USD'},{s:'GBPUSD=X',n:'GBP/USD'},{s:'USDJPY=X',n:'USD/JPY'},{s:'USDTRY=X',n:'USD/TRY'},{s:'GC=F',n:'Gold'},{s:'SI=F',n:'Silver'},{s:'CL=F',n:'Crude Oil'},{s:'NG=F',n:'Natural Gas'},{s:'HG=F',n:'Copper'},{s:'PL=F',n:'Platinum'},{s:'PA=F',n:'Palladium'}]
};
const PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];

/* --- 1.5. LIVE FEED (WebSocket) --- */
const LiveFeed = {
    ws: null,
    start: (symbol, interval) => {
        if(LiveFeed.ws) { 
            LiveFeed.ws.onclose = null; 
            LiveFeed.ws.close(); 
            LiveFeed.ws = null; 
        }
        
        const indicator = document.getElementById('live-indicator');
        if(App.safeVal('market') !== 'CRYPTO') {
            if(indicator) indicator.classList.remove('on');
            return;
        }

        const s = symbol.toLowerCase();
        const url = `wss://stream.binance.com:9443/ws/${s}@kline_${interval}`;
        
        try {
            LiveFeed.ws = new WebSocket(url);
            LiveFeed.ws.onopen = () => {
                if(document.getElementById('live-indicator')) document.getElementById('live-indicator').classList.add('on');
            };
            LiveFeed.ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if(data.k) {
                    const k = data.k;
                    const candle = {
                        time: k.t / 1000,
                        open: parseFloat(k.o),
                        high: parseFloat(k.h),
                        low: parseFloat(k.l),
                        close: parseFloat(k.c),
                        value: parseFloat(k.v),
                        color: (parseFloat(k.c) >= parseFloat(k.o) ? 'rgba(8, 153, 129, 0.3)' : 'rgba(242, 54, 69, 0.3)')
                    };
                    App.updateRealTime(candle);
                }
            };
            LiveFeed.ws.onclose = () => {
                if(document.getElementById('live-indicator')) document.getElementById('live-indicator').classList.remove('on');
            };
            LiveFeed.ws.onerror = (e) => {
                if(document.getElementById('live-indicator')) document.getElementById('live-indicator').classList.remove('on');
            };
        } catch(e) { console.error(e); }
    },
    stop: () => {
        if(LiveFeed.ws) { 
            LiveFeed.ws.onclose = null; 
            LiveFeed.ws.close(); 
            LiveFeed.ws = null; 
        }
        if(document.getElementById('live-indicator')) document.getElementById('live-indicator').classList.remove('on');
    }
};

/* --- 2. ASSET MANAGER --- */
const AssetManager = {
    save: () => {
        const b = new Blob([JSON.stringify(ASSETS)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ProTrade_AssetList.json'; a.click();
        App.toast('Enstr√ºman listesi indirildi', 'green');
    },
    load: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try { ASSETS = JSON.parse(e.target.result); App.loadSyms(); App.toast('Enstr√ºman listesi g√ºncellendi', 'green'); } 
            catch(e) { App.toast('Dosya hatasƒ±', 'red'); }
            input.value = '';
        };
        r.readAsText(f);
    },
    initCrypto: async () => {
        const cachedAssets = await CacheDB.get('assets', 'crypto_top_50');
        if (cachedAssets && cachedAssets.length > 0) {
            ASSETS.CRYPTO = cachedAssets;
            return;
        }

        // Y√ºkleme ekranƒ±nƒ± g√∂ster
        App.modal(true, 'Varlƒ±k Listesi', 'Binance verileri √ßekiliyor...', 0);

        try {
            const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
            
            if (!response.ok) throw new Error("API baƒülantƒ± hatasƒ±: " + response.status);

            const r = await response.json(); 

            if (!Array.isArray(r)) throw new Error("API yanƒ±tƒ± beklenen formatta (array) deƒüil.");

            const sorted = r.filter(t => t.symbol.endsWith('USDT') && !t.symbol.includes('UP') && !t.symbol.includes('DOWN'))
                            .sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
                            .slice(0, 50)
                            .map(t => ({ s: t.symbol, n: t.symbol }));
            
            if (sorted.length > 0) {
                ASSETS.CRYPTO = sorted;
                await CacheDB.put('assets', 'crypto_top_50', sorted);
                App.toast("Binance'den son 24 saatteki en hacimli kripto listesi cache'e y√ºklendi", 'green');
            }
        } catch (e) {
            console.error("Crypto list fetch failed", e);
            ASSETS.CRYPTO = [{s:'BTCUSDT',n:'Bitcoin'}, {s:'ETHUSDT',n:'Ethereum'}, {s:'BNBUSDT',n:'Binance Coin'}];
            App.toast('Liste √ßekilemedi, varsayƒ±lanlar y√ºklendi.', 'red');
        } finally {
            // Y√ºkleme ekranƒ±nƒ± kapat
            App.modal(false);
        }
    },
    updateCryptoList: async () => {
        const btn = document.getElementById('btn-update-assets');
        if(btn) btn.disabled = true;
        
        try {
            await CacheDB.delete('assets', 'crypto_top_50');
            ASSETS.CRYPTO = []; 
            await AssetManager.initCrypto();
            if(App.safeVal('market') === 'CRYPTO') {
                App.loadSyms();
            }
        } catch(e) {
            console.error(e);
        } finally {
            if(btn) btn.disabled = false;
        }
    }
};

/* --- 3. INDICATORS --- */
const Indicators = {
    ema: (data, period) => {
        let k = 2 / (period + 1); let r = new Array(data.length).fill(null); let sum = 0;
        for(let i=0; i<period && i<data.length; i++) sum += data[i].close;
        if(data.length >= period) { r[period-1] = sum/period; for(let i=period; i<data.length; i++) r[i] = (data[i].close * k) + (r[i-1] * (1-k)); }
        return r;
    },
    sma: (arr, period) => {
        let r = new Array(arr.length).fill(null); let sum = 0;
        for (let i = 0; i < arr.length; i++) { sum += arr[i]; if (i >= period) sum -= arr[i - period]; if (i >= period - 1) r[i] = sum / period; }
        return r;
    },
    bb: (d, len, mult) => {
        let r = [];
        for(let i=0; i<d.length; i++) {
            if(i < len - 1) { r.push({u:null, l:null, m:null}); continue; }
            let slice = d.slice(i - len + 1, i + 1); let sum = 0; slice.forEach(c => sum += c.close); let mean = sum / len;
            let sqDiffSum = 0; slice.forEach(c => sqDiffSum += Math.pow(c.close - mean, 2)); let stdDev = Math.sqrt(sqDiffSum / len);
            r.push({ u: mean + (stdDev * mult), l: mean - (stdDev * mult), m: mean });
        }
        return r;
    },
    superTrend:(d,p,f)=>{let r=[],tr=[0];for(let i=1;i<d.length;i++)tr.push(Math.max(d[i].high-d[i].low,Math.abs(d[i].high-d[i-1].close),Math.abs(d[i].low-d[i-1].close)));let a=new Array(d.length).fill(0),s=0;for(let i=0;i<p;i++)s+=tr[i];a[p-1]=s/p;for(let i=p;i<d.length;i++)a[i]=(a[i-1]*(p-1)+tr[i])/p;let dir=1;for(let i=0;i<d.length;i++){if(i<p){r.push({d:1});continue}let m=(d[i].high+d[i].low)/2,bu=m+f*a[i],bl=m-f*a[i],pu=r[i-1].u||bu,pl=r[i-1].l||bl,fu=(bu<pu||d[i-1].close>pu)?bu:pu,fl=(bl>pl||d[i-1].close<pl)?bl:pl;if(r[i-1].d===1&&d[i].close<fl)dir=-1;else if(r[i-1].d===-1&&d[i].close>fu)dir=1;else dir=r[i-1].d;let sig=null;if(dir===1&&r[i-1].d===-1)sig='LONG';if(dir===-1&&r[i-1].d===1)sig='SHORT';r.push({d:dir,u:fu,l:fl,s:sig});}return r;},
    psar:(d,s,i,m)=>{let r=new Array(d.length).fill({}),l=true,a=s,sar=d[0].low,ep=d[0].high;for(let k=1;k<d.length;k++){sar=sar+a*(ep-sar);if(l){if(d[k].low<sar){l=false;sar=ep;ep=d[k].low;a=s}else{if(d[k].high>ep){ep=d[k].high;a=Math.min(a+i,m)}}}else{if(d[k].high>sar){l=true;sar=ep;ep=d[k].high;a=s}else{if(d[k].low<ep){ep=d[k].low;a=Math.min(a+i,m)}}}let sig=null;if(l&&!r[k-1].l)sig='LONG';if(!l&&r[k-1].l)sig='SHORT';r[k]={sar,l,s:sig};}return r;},
    stoch:(d,kP,dP)=>{let r=[],k=[],l=0,h=0;for(let i=0;i<d.length;i++){if(i<kP){r.push({k:50,s:null});continue}let sl=d.slice(i-kP+1,i+1);l=Math.min(...sl.map(x=>x.low));h=Math.max(...sl.map(x=>x.high));k.push(((d[i].close-l)/(h-l))*100);}let dL=[];for(let i=0;i<k.length;i++){if(i<dP){dL.push(50);continue}let s=0;for(let j=0;j<dP;j++)s+=k[i-j];dL.push(s/dP);}return k.map((v,i)=>{let sig=null;if(i>0){if(v>dL[i]&&k[i-1]<=dL[i-1]&&v<20)sig='LONG';if(v<dL[i]&&k[i-1]>=dL[i-1]&&v>80)sig='SHORT'}return{s:sig,k:v};});},
    turtle:(d,e,x)=>{let r=[];for(let i=0;i<d.length;i++){if(i<e){r.push({s:null});continue}let h=Math.max(...d.slice(i-e,i).map(z=>z.high)),l=Math.min(...d.slice(i-e,i).map(z=>z.low));let s=null;if(d[i].close>h)s='LONG';if(d[i].close<l)s='SHORT';r.push({s});}return r;},
    emaCross:(d,f,s)=>{const ema=(a,p)=>{let r=[],k=2/(p+1),e=a[0].close;a.forEach(z=>{e=z.close*k+e*(1-k);r.push(e)});return r};let ef=ema(d,f),es=ema(d,s);return ef.map((v,i)=>{let sig=null;if(i>0){if(v>es[i]&&ef[i-1]<=es[i-1])sig='LONG';if(v<es[i]&&ef[i-1]>=es[i-1])sig='SHORT'}return{s:sig}})},
    rsi:(d,p)=>{let r=[],g=0,l=0;for(let i=0;i<d.length;i++){if(i===0){r.push({time:d[i].time,value:50});continue}let c=d[i].close-d[i-1].close;let ug=c>0?c:0,ul=c<0?-c:0;if(i<p){g+=ug;l+=ul;r.push({time:d[i].time,value:50})}else if(i===p){g/=p;l/=p;r.push({time:d[i].time,value:100-(100/(1+g/l))})}else{g=(g*(p-1)+ug)/p;l=(l*(p-1)+ul)/p;r.push({time:d[i].time,value:l===0?100:100-(100/(1+g/l))})}}return r;},
    rsiStrategy:(d, len, overbought, oversold) => {
        let vals = Indicators.rsi(d, len).map(x=>x.value);
        return vals.map((v, i) => { let sig = null; if (i > 0) { if (v > oversold && vals[i-1] <= oversold) sig = 'LONG'; if (v < overbought && vals[i-1] >= overbought) sig = 'SHORT'; } return { s: sig }; });
    },
    macd: (d, fast, slow, signal) => {
        let emaF = Indicators.ema(d, fast); let emaS = Indicators.ema(d, slow); let macdLine = emaF.map((v,i) => (v!==null && emaS[i]!==null) ? v - emaS[i] : 0);
        let k = 2 / (signal + 1); let sigLine = new Array(d.length).fill(0); let sum = 0, count = 0;
        for(let i=0; i<d.length; i++) { if(macdLine[i]!==0 || i > slow) { if(count < signal) { sum += macdLine[i]; count++; sigLine[i]=sum/count; } else { sigLine[i] = (macdLine[i] * k) + (sigLine[i-1] * (1-k)); } } }
        return macdLine.map((v, i) => { let sig = null; if (i > slow + signal) { if (v > sigLine[i] && macdLine[i-1] <= sigLine[i-1]) sig = 'LONG'; if (v < sigLine[i] && macdLine[i-1] >= sigLine[i-1]) sig = 'SHORT'; } return { s: sig }; });
    },
    vwap: (d, period) => {
        let r = []; for(let i=0; i<d.length; i++) { let start = Math.max(0, i - period + 1); let sumPV = 0; let sumV = 0;
            for(let j=start; j<=i; j++) { let p = (d[j].high + d[j].low + d[j].close) / 3; sumPV += p * d[j].value; sumV += d[j].value; }
            let vwap = sumV ? sumPV / sumV : d[i].close; let sig = null; if (i>0) { if(d[i].close > vwap && d[i-1].close <= vwap) sig = 'LONG'; if(d[i].close < vwap && d[i-1].close >= vwap) sig = 'SHORT'; } r.push({s:sig}); } return r;
    },
    adx: (d, len, threshold) => {
        let tr=[], pdm=[], mdm=[]; for(let i=0; i<d.length; i++){ if(i===0) { tr.push(0); pdm.push(0); mdm.push(0); continue; } let h=d[i].high, l=d[i].low, c=d[i].close, pc=d[i-1].close; tr.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); let up = h - d[i-1].high; let down = d[i-1].low - l; pdm.push((up > down && up > 0) ? up : 0); mdm.push((down > up && down > 0) ? down : 0); }
        const smooth = (arr, n) => { let res = new Array(arr.length).fill(0); let sum=0; for(let i=0;i<n;i++) sum+=arr[i]; res[n-1]=sum; for(let i=n; i<arr.length; i++) res[i] = res[i-1] - (res[i-1]/n) + arr[i]; return res; };
        let sTR = smooth(tr, len); let sPDM = smooth(pdm, len); let sMDM = smooth(mdm, len); let dx = []; for(let i=0; i<d.length; i++){ let diPlus = (sTR[i]===0)?0 : 100*(sPDM[i]/sTR[i]); let diMinus = (sTR[i]===0)?0 : 100*(sMDM[i]/sTR[i]); let sum = diPlus + diMinus; dx.push( sum===0 ? 0 : 100 * Math.abs(diPlus-diMinus)/sum ); }
        let adxLine = smooth(dx, len); return adxLine.map((v, i) => { let sig = null; if(i > len*2) { let diPlus = (sTR[i]===0)?0 : 100*(sPDM[i]/sTR[i]); let diMinus = (sTR[i]===0)?0 : 100*(sMDM[i]/sTR[i]); let prevDiPlus = 100*(sPDM[i-1]/sTR[i-1]); let prevDiMinus = 100*(sMDM[i-1]/sTR[i-1]); if (v > threshold) { if (diPlus > diMinus && prevDiPlus <= prevDiMinus) sig = 'LONG'; if (diPlus < diMinus && prevDiPlus >= prevDiMinus) sig = 'SHORT'; } } return { s: sig }; });
    },
    williams: (d, len, level) => {
        let r = []; for(let i=0; i<d.length; i++) { if(i < len) { r.push({s:null}); continue; } let slice = d.slice(i-len+1, i+1); let hh = Math.max(...slice.map(x=>x.high)); let ll = Math.min(...slice.map(x=>x.low)); let wr = -100 * (hh - d[i].close) / (hh - ll); let sig = null; let lower = -100 + level; let upper = -level; let prevSlice = d.slice(i-len, i); let phh = Math.max(...prevSlice.map(x=>x.high)); let pll = Math.min(...prevSlice.map(x=>x.low)); let pwr = -100 * (phh - d[i-1].close) / (phh - pll); if (wr > lower && pwr <= lower) sig = 'LONG'; if (wr < upper && pwr >= upper) sig = 'SHORT'; r.push({s:sig}); } return r;
    },
    lsvt: (d, bbLen, bbMult, volLen, volFactor) => {
        let bands = Indicators.bb(d, bbLen, bbMult); let vols = d.map(x => x.value); let volSma = Indicators.sma(vols, volLen); let rsi = Indicators.rsi(d, 14).map(x=>x.value);
        return d.map((curr, i) => {
            let sig = null;
            if (i > bbLen && bands[i].u !== null) {
                let b = bands[i]; let vAvg = volSma[i];
                if (curr.low < b.l && curr.close > b.l && curr.value > (vAvg * volFactor) && rsi[i] < 55) sig = 'LONG';
                else if (curr.high > b.u && curr.close < b.u && curr.value > (vAvg * volFactor) && rsi[i] > 45) sig = 'SHORT';
            } return { s: sig };
        });
    }
};

/* --- 4. LOGIC ENGINE --- */
const Logic={
    backtest:(d,st,p, useTpSl=false, tpPct=0, slPct=0)=>{
        let sigs=[];
        if(st==='supertrend')sigs=Indicators.superTrend(d,p.st_p,p.st_f).map(x=>x.s);
        if(st==='psar')sigs=Indicators.psar(d,p.ps_s,p.ps_i,p.ps_m).map(x=>x.s);
        if(st==='stoch')sigs=Indicators.stoch(d,p.st_k,p.st_d).map(x=>x.s);
        if(st==='turtle')sigs=Indicators.turtle(d,p.tt_in,p.tt_out).map(x=>x.s);
        if(st==='emacross')sigs=Indicators.emaCross(d,p.ema_f,p.ema_s).map(x=>x.s);
        if(st==='rsi_strat') sigs=Indicators.rsiStrategy(d, p.rsi_len, p.rsi_ob, p.rsi_os).map(x=>x.s);
        if(st==='macd') sigs=Indicators.macd(d, p.mac_f, p.mac_s, p.mac_sig).map(x=>x.s);
        if(st==='vwap') sigs=Indicators.vwap(d, p.vw_p).map(x=>x.s);
        if(st==='adx') sigs=Indicators.adx(d, p.adx_len, p.adx_th).map(x=>x.s);
        if(st==='williams') sigs=Indicators.williams(d, p.w_len, p.w_lvl).map(x=>x.s);
        if(st==='lsvt') sigs=Indicators.lsvt(d, p.bb_len, p.bb_mult, p.vol_len, p.vol_factor).map(x=>x.s);
        
        let tr=[],mk=[],pos=null,w=0,bal=parseFloat(App.safeVal('balance') || 1000),ls=null;
        
        for(let i=1;i<d.length;i++){
            let s=sigs[i]; if(s)ls=s;
            let current = d[i];
            if(pos && useTpSl) {
                let exitPrice = null; let reason = '';
                if(pos.type === 'LONG') {
                    const stopPrice = pos.p * (1 - slPct/100); const targetPrice = pos.p * (1 + tpPct/100);
                    if (current.low <= stopPrice) { exitPrice = stopPrice; reason = 'Stop Loss'; } 
                    else if (current.high >= targetPrice) { exitPrice = targetPrice; reason = 'Take Profit'; }
                } 
                else if (pos.type === 'SHORT') {
                    const stopPrice = pos.p * (1 + slPct/100); const targetPrice = pos.p * (1 - tpPct/100);
                    if (current.high >= stopPrice) { exitPrice = stopPrice; reason = 'Stop Loss'; } 
                    else if (current.low <= targetPrice) { exitPrice = targetPrice; reason = 'Take Profit'; }
                }
                if (exitPrice) {
                    let pnl = (pos.type==='LONG' ? exitPrice - pos.p : pos.p - exitPrice) * pos.amt;
                    if(pnl>0) w++; tr.push({type:pos.type,et:pos.t,ep:pos.p,xt:current.time,xp:exitPrice,pnl,reason});
                    mk.push({time:current.time,position:pos.type==='LONG'?'aboveBar':'belowBar',color:reason==='Take Profit'?'#089981':'#f23645',shape:'circle',text:reason,price:exitPrice});
                    pos = null; continue; 
                }
            }
            if(pos) {
                if((pos.type==='LONG'&&s==='SHORT')||(pos.type==='SHORT'&&s==='LONG')){
                    let pnl=(pos.type==='LONG'?current.close-pos.p:pos.p-current.close)*pos.amt;
                    if(pnl>0)w++; tr.push({type:pos.type,et:pos.t,ep:pos.p,xt:current.time,xp:current.close,pnl,reason:'Sinyal'});
                    mk.push({time:current.time,position:pos.type==='LONG'?'aboveBar':'belowBar',color:'#848d97',shape:'circle',text:'Exit',price:current.close});
                    pos=null;
                }
            }
            if(!pos&&s){
                pos={type:s,p:current.close,t:current.time,amt:bal/current.close};
                mk.push({time:current.time,position:s==='LONG'?'belowBar':'aboveBar',color:s==='LONG'?'#089981':'#f23645',shape:s==='LONG'?'arrowUp':'arrowDown',text:s,price:current.close});
            }
        }
        
        // --- COUNT FIX: Total Entry Count (Closed Trades + Open Position) ---
        const tradeCount = tr.length + (pos ? 1 : 0);
        
        return {trades:tr, markers:mk, pnl:tr.reduce((a,b)=>a+b.pnl,0), winRate:tr.length?Math.round((w/tr.length)*100):0, openPos:pos, lastSignal:ls, count: tradeCount}
    }
};

/* --- 5. CONFIG MANAGER --- */
const ConfigManager={
    save:()=>{
        if(!Scanner.results || Object.keys(Scanner.results).length === 0) { App.toast('Hata: √ñnce T√úM Pƒ∞YASAYI TARA i≈ülemini tamamlayƒ±n!', 'red'); return; }
        const c={ market:App.safeVal('market'),symbol:App.safeVal('symbol'),interval:App.safeVal('interval'),limit:App.safeVal('limit'),strategy:App.safeVal('strategy'),balance:App.safeVal('balance'),visRsi:App.safeVal('vis-rsi-len'),scanRes:Scanner.results, useTpSl: document.getElementById('use-tpsl').checked, tpVal: App.safeVal('tp-val'), slVal: App.safeVal('sl-val'), params:{},timestamp: new Date().toISOString() };
        const s=App.safeVal('strategy'); if(s){App.paramsDef[s].forEach(p=>c.params[p.id]=App.safeVal(p.id));}
        const b=new Blob([JSON.stringify(c)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ProTrade_Result.json'; a.click();
        App.toast('Tarama sonu√ßlarƒ± kaydedildi.','green');
    },
    load:(input)=>{
        const f=input.files[0]; if(!f) return; const r=new FileReader();
        r.onload=(e)=>{try{
            const c=JSON.parse(e.target.result);
            if(document.getElementById('market')) { document.getElementById('market').value=c.market; App.loadSyms(); }
            if(document.getElementById('interval')) document.getElementById('interval').value=c.interval;
            if(document.getElementById('strategy')) document.getElementById('strategy').value=c.strategy;
            if(c.useTpSl !== undefined) { document.getElementById('use-tpsl').checked = c.useTpSl; document.getElementById('tp-val').value = c.tpVal; document.getElementById('sl-val').value = c.slVal; App.toggleTpSlManual(); }
            App.renderUI(); for(let k in c.params) if(document.getElementById(k)) document.getElementById(k).value=c.params[k];
            if(c.scanRes){ Scanner.results=c.scanRes; Scanner.renderResults(); App.switchTab('scanner'); App.toast('Tarama verileri y√ºklendi.','green'); } 
            App.updateHeaders();
        }catch(x){ console.error(x); App.toast('Dosya formatƒ± hatalƒ±!','red'); } input.value = '';};
        r.readAsText(f);
    }
};

/* --- 6. OPTIMIZER ENGINE --- */
const Optimizer={
    getV:(s)=>{let v=[];
        if(s==='supertrend') for(let p=5;p<40;p+=2)for(let f=1;f<6;f+=0.5)v.push({st_p:p,st_f:f});
        if(s==='psar') for(let x=0.01;x<0.05;x+=0.01)v.push({ps_s:x,ps_i:x,ps_m:0.2});
        if(s==='stoch') for(let k=5;k<30;k+=2)for(let d=2;d<10;d+=1)v.push({st_k:k,st_d:d});
        if(s==='turtle') for(let i=10;i<50;i+=5)for(let o=5;o<25;o+=2)if(i>o)v.push({tt_in:i,tt_out:o});
        if(s==='emacross') for(let f=5;f<30;f+=2)for(let sl=10;sl<100;sl+=5)if(sl>f)v.push({ema_f:f,ema_s:sl});
        if(s==='rsi_strat') for(let l=7;l<25;l+=1) for(let ob=65;ob<=85;ob+=5) for(let os=15;os<=35;os+=5) v.push({rsi_len:l, rsi_ob:ob, rsi_os:os});
        if(s==='macd') for(let f=8;f<20;f+=2) for(let sl=20;sl<40;sl+=2) for(let sg=5;sg<15;sg+=1) if(sl>f) v.push({mac_f:f, mac_s:sl, mac_sig:sg});
        if(s==='vwap') for(let p=10;p<100;p+=10) v.push({vw_p:p});
        if(s==='adx') for(let l=7;l<28;l+=2) for(let t=15;t<=35;t+=5) v.push({adx_len:l, adx_th:t});
        if(s==='williams') for(let l=10;l<50;l+=5) for(let lv=10;lv<=30;lv+=5) v.push({w_len:l, w_lvl:lv});
        if(s==='lsvt') for(let bbl=20; bbl<=50; bbl+=10) for(let bbm=2.0; bbm<=3.0; bbm+=0.5) for(let vf=1.5; vf<=3.5; vf+=0.5) v.push({bb_len:bbl, bb_mult:bbm, vol_len:20, vol_factor:vf});
        return v;
    },
    genKey: (symbol, interval, strategy) => { return `${symbol || App.safeVal('symbol')}_${interval || App.safeVal('interval')}_${strategy || App.safeVal('strategy')}`; },
    updateCacheUI: async () => {
        const key = Optimizer.genKey(); const cached = await CacheDB.get('optimizations', key); const infoEl = document.getElementById('opt-cache-info'); const btnDel = document.getElementById('btn-del-opt-cache');
        if (cached) {
            const diffMins = Math.floor((Date.now() - cached.time)/60000); const h = Math.floor(diffMins/60); const m = diffMins % 60;
            infoEl.innerText = `${h>0?h+' saat ':''}${m} dakika √∂nce cachelenmi≈ütir`;
            btnDel.innerText = `${App.safeVal('symbol')}_${App.safeVal('interval')} i√ßin en iyi deƒüerleri sil`;
            btnDel.style.display = 'block';
        } else { infoEl.innerText = ''; btnDel.style.display = 'none'; }
    },
    clearCurrent: async () => { const key = Optimizer.genKey(); await CacheDB.delete('optimizations', key); Optimizer.updateCacheUI(); App.toast('Cache silindi', 'green'); },
    clearAll: async () => { const count = await CacheDB.clearStore('optimizations'); Optimizer.updateCacheUI(); App.toast(`${count} adet kayƒ±t silindi`, 'green'); },
    optimizeSymbol: async (data, strat, useTpSl, updateCallback) => {
        const v = Optimizer.getV(strat); 
        let tpRanges = [0], slRanges = [0];
        if (useTpSl) { tpRanges = []; for(let t=1; t<=30; t++) tpRanges.push(t); slRanges = []; for(let s=1; s<=15; s++) slRanges.push(s); }
        let testCases = [];
        for(const p of v) {
            const step = v.length > 50 ? 2 : 1; 
            for(let ti=0; ti<tpRanges.length; ti+=step) { for(let si=0; si<slRanges.length; si+=step) { testCases.push({p, tp: tpRanges[ti], sl: slRanges[si]}); } }
        }
        if(testCases.length === 0) return null;
        let best = -Infinity; let bestResult = null; const BATCH = 500; 
        for(let i=0; i<testCases.length; i+=BATCH){
            const slice = testCases.slice(i, i+BATCH);
            for(const c of slice) {
                const r = Logic.backtest(data, strat, c.p, (c.tp > 0 || c.sl > 0), c.tp, c.sl);
                if(r.pnl > best) { best = r.pnl; bestResult = { p: c.p, tp: c.tp, sl: c.sl, stats: r }; }
            }
            if(updateCallback) updateCallback((i/testCases.length)*100);
            await new Promise(r=>setTimeout(r,0));
        }
        return bestResult;
    },
    runSingle: async (force = false) => {
        const s = App.safeVal('strategy'), d = App.data; if(!d || !d.length) return;
        const key = Optimizer.genKey();
        if (!force) {
            const cached = await CacheDB.get('optimizations', key);
            if (cached) {
                const bp = cached.params; for(let k in bp) if(document.getElementById(k)) document.getElementById(k).value=bp[k];
                if(cached.tp !== undefined) { document.getElementById('use-tpsl').checked = (cached.tp > 0 || cached.sl > 0); App.updateTpSlUI(); document.getElementById('tp-val').value = cached.tp; document.getElementById('sl-val').value = cached.sl; }
                Optimizer.updateCacheUI(); App.run(true); return;
            }
        }
        const useTpSl = document.getElementById('use-tpsl').checked;
        App.modal(true,'Optimize','Hesaplanƒ±yor...',0); await new Promise(r=>setTimeout(r,100));
        const res = await Optimizer.optimizeSymbol(d, s, useTpSl, (pct) => { App.modal(true,'Optimize','Taranƒ±yor...', pct); });
        if(res){
            const bp = res.p; for(let k in bp) if(document.getElementById(k)) document.getElementById(k).value=bp[k];
            if(useTpSl) { document.getElementById('tp-val').value = res.tp; document.getElementById('sl-val').value = res.sl; }
            await CacheDB.put('optimizations', key, { params: bp, tp: useTpSl ? res.tp : 0, sl: useTpSl ? res.sl : 0, time: Date.now() });
            Optimizer.updateCacheUI();
            if(force) App.toast(`Optimum: $${res.stats.pnl.toFixed(2)}`,'green');
            App.run(true);
        }
        App.modal(false);
    }
};

/* --- 6. SCANNER ENGINE --- */
const Scanner={
    results:{},
    start:async()=>{
        const s=App.safeVal('strategy'), syms=ASSETS.CRYPTO;
        const useTpSl = document.getElementById('scan-tpsl-opt').checked;
        const interval = App.safeVal('interval');
        App.modal(true,'Tarama','Ba≈ülƒ±yor...',0); Scanner.results={};
        
        for(let i=0;i<syms.length;i++){
            const symName = syms[i].s;
            App.modal(true,`Taranƒ±yor: ${symName}`,`${i+1}/${syms.length}`,(i/syms.length)*100);
            
            // 1. Fetch Data
            let d = await App.fetchData(symName); 
            if(d && d.length > 50){
                const optKey = Optimizer.genKey(symName, interval, s);
                let cachedOpt = await CacheDB.get('optimizations', optKey);
                let optRes;
                
                if(cachedOpt) {
                    const run = Logic.backtest(d, s, cachedOpt.params, (cachedOpt.tp > 0 || cachedOpt.sl > 0), cachedOpt.tp, cachedOpt.sl);
                    optRes = { p: cachedOpt.params, tp: cachedOpt.tp, sl: cachedOpt.sl, stats: run };
                } else {
                    optRes = await Optimizer.optimizeSymbol(d, s, useTpSl, null);
                    if(optRes) await CacheDB.put('optimizations', optKey, { params: optRes.p, tp: optRes.tp, sl: optRes.sl, time: Date.now() });
                }

                if(optRes) {
                    const run = optRes.stats;
                    // Scanner should use the SAME 'count' logic as Logic.backtest
                    const tradesCount = run.count; // This includes open pos
                    
                    let lastT = run.openPos ? run.openPos.t : (run.trades.length>0 ? run.trades[run.trades.length-1].et : 0);
                    Scanner.results[symName]={
                        bestParams: optRes.p, bestTp: optRes.tp, bestSl: optRes.sl, 
                        pnl: run.pnl, winRate: run.winRate, 
                        trades: tradesCount, 
                        lastSignal: run.lastSignal, openPos: run.openPos, lastEntryTime: lastT
                    };
                }
            }
        }
        App.modal(false); Scanner.renderResults(); App.switchTab('scanner');
    },
    renderResults:()=>{
        const tb=document.querySelector('#t-scanner tbody'); if(!tb) return; tb.innerHTML='';
        const keys=Object.keys(Scanner.results).sort((a,b)=>Scanner.results[b].pnl - Scanner.results[a].pnl);
        keys.forEach(k=>{
            const r=Scanner.results[k];
            let st=r.openPos ? `<span class="badge ${r.openPos.type==='LONG'?'b-long':'b-short'}">A√áIK: ${r.openPos.type}</span>` : (r.lastSignal ? `<span class="badge ${r.lastSignal==='LONG'?'b-long':'b-short'}">Sinyal: ${r.lastSignal}</span>` : `<span class="badge b-neutral">Beklemede</span>`);
            const tr=document.createElement('tr');
            tr.innerHTML=`<td><b>${k}</b></td><td>${new Date(r.lastEntryTime*1000).toLocaleString('tr-TR', {timeZone: 'Europe/Istanbul'})}</td><td>${st}</td><td class="${r.pnl>=0?'green':'red'}">${r.pnl.toFixed(2)}</td><td>%${r.winRate}</td><td>${r.trades}</td><td><button class="btn-blue-std" style="padding:2px 6px; width:auto;" onclick="Scanner.load('${k}')">Se√ß</button></td>`;
            tb.appendChild(tr);
        });
    },
    load:(s)=>{
        const symEl = document.getElementById('symbol');
        if(symEl) {
            symEl.value=s;
            const res=Scanner.results[s];
            if(res){
                // 1. Load Params
                const b=res.bestParams; for(let k in b) if(document.getElementById(k)) document.getElementById(k).value=b[k];
                if(res.bestTp !== undefined && (res.bestTp > 0 || res.bestSl > 0)) {
                    document.getElementById('use-tpsl').checked = true; App.updateTpSlUI();
                    document.getElementById('tp-val').value = res.bestTp; document.getElementById('sl-val').value = res.bestSl;
                } else { 
                    if(res.bestTp === 0 && res.bestSl === 0) { document.getElementById('use-tpsl').checked = false; App.updateTpSlUI(); } 
                }
                // 2. Force Cache Update so autoRun sees it
                const key = `${s}_${App.safeVal('interval')}_${App.safeVal('strategy')}`;
                const useTpSl = document.getElementById('use-tpsl').checked;
                CacheDB.put('optimizations', key, {
                    params: b,
                    tp: useTpSl ? res.bestTp : 0,
                    sl: useTpSl ? res.bestSl : 0,
                    time: Date.now()
                }).then(() => {
                    // 3. Trigger Full Auto Run
                    App.autoRun();
                    App.switchTab('history');
                    App.toast('Optimize Ayarlar Y√ºklendi','green');
                });
            }
        }
    }
};

/* --- 7. APP CONTROLLER --- */
const App = {
    chart:null, cSeries:null, vSeries:null, rsiSeries:null, data:[], intervalId:null, currentPrecision:2,
    paramsDef:{
        supertrend:[{id:'st_p',l:'Periyot',v:10},{id:'st_f',l:'Fakt√∂r',v:3,s:0.1}],
        psar:[{id:'ps_s',l:'Ba≈ülangƒ±√ß',v:0.02,s:0.01},{id:'ps_i',l:'Adƒ±m',v:0.02,s:0.01},{id:'ps_m',l:'Max',v:0.2,s:0.01}],
        stoch:[{id:'st_k',l:'K',v:14},{id:'st_d',l:'D',v:3}],
        turtle:[{id:'tt_in',l:'Giri≈ü',v:20},{id:'tt_out',l:'√áƒ±kƒ±≈ü',v:10}],
        emacross:[{id:'ema_f',l:'Fast',v:9},{id:'ema_s',l:'Slow',v:21}],
        rsi_strat:[{id:'rsi_len',l:'RSI Periyot',v:14},{id:'rsi_ob',l:'A≈üƒ±rƒ± Alƒ±m (Sat)',v:70},{id:'rsi_os',l:'A≈üƒ±rƒ± Satƒ±m (Al)',v:30}],
        macd:[{id:'mac_f',l:'Hƒ±zlƒ± (Fast)',v:12},{id:'mac_s',l:'Yava≈ü (Slow)',v:26},{id:'mac_sig',l:'Sinyal',v:9}],
        vwap:[{id:'vw_p',l:'Rolling Period',v:20}],
        adx:[{id:'adx_len',l:'ADX Periyot',v:14},{id:'adx_th',l:'Trend E≈üiƒüi',v:25}],
        williams:[{id:'w_len',l:'Williams Periyot',v:14},{id:'w_lvl',l:'Alt/√úst Sƒ±nƒ±r (-)',v:20}],
        lsvt:[{id:'bb_len',l:'Likidasyon Alanƒ± (BB Len)',v:20},{id:'bb_mult',l:'Sapma (Std Dev)',v:2.0,s:0.1},{id:'vol_len',l:'Hacim Ort. Periyodu',v:20},{id:'vol_factor',l:'Hacim Patlama √áarpanƒ±',v:2.0,s:0.1}]
    },
    safeVal: (id) => { const el = document.getElementById(id); return el ? el.value : ''; },
    formatPrice: (price) => {
        if (price === null || price === undefined) return '--';
        return parseFloat(price).toFixed(App.currentPrecision);
    },
    
    // ** CHECK VERSION ON STARTUP **
    checkVersion: async () => {
        const storedVer = await CacheDB.get('meta', 'app_version');
        if (storedVer !== DB_VERSION) {
            console.log("Version Mismatch. Clearing DB.");
            await CacheDB.wipeAll(); 
            await CacheDB.open(); 
            await CacheDB.put('meta', 'app_version', DB_VERSION);
            location.reload();
            return false;
        }
        return true;
    },
	// Akƒ±llƒ± ve Responsive Yakƒ±nla≈ütƒ±rma Fonksiyonu
    applySmartZoom: () => {
        if (!App.data || App.data.length === 0) return;
        
        const chartWidth = document.getElementById('chart').clientWidth;
        const totalBars = App.data.length;

        // Mobil i√ßin en az 100 mum, masa√ºst√º i√ßin ekran geni≈üliƒüine g√∂re (Geni≈ülik / 8)
        let barsToShow = Math.max(100, Math.floor(chartWidth / 8));
        
        if (totalBars > barsToShow) {
            App.chart.timeScale().setVisibleLogicalRange({
                from: totalBars - barsToShow,
                to: totalBars
            });
        } else {
            App.chart.timeScale().fitContent();
        }
    },
    init: async ()=>{
        // 1. Check Version & Init DB
        if (!(await App.checkVersion())) return;

        // 2. Load Top 50 Crypto
        await AssetManager.initCrypto();

        const d=document.getElementById('chart'); if(!d) return;
        
        // -- CHART CONFIG --
        App.chart=LightweightCharts.createChart(d,{
            layout:{background:{color:'#0d1117'},textColor:'#848d97'},
            grid:{vertLines:{color:'rgba(48, 54, 61, 0.4)'},horzLines:{color:'rgba(48, 54, 61, 0.4)'}},
            timeScale:{
                borderColor:'#30363d',
                timeVisible:true,
                // ISTANBUL TIME FIX FOR AXIS
                tickMarkFormatter: (time, tickMarkType, locale) => {
                    return new Date(time * 1000).toLocaleTimeString('tr-TR', { 
                        timeZone: 'Europe/Istanbul', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }
            },
            localization: {
                locale: 'tr-TR',
                // ISTANBUL TIME FIX FOR CROSSHAIR LABEL
                timeFormatter: (time) => {
                    const date = new Date(time * 1000);
                    return date.toLocaleString('tr-TR', { 
                        timeZone: 'Europe/Istanbul', 
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }
            },
            rightPriceScale:{borderColor:'#30363d'},
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            watermark: {
                visible: true,
                fontSize: 48,
                horzAlign: 'center',
                vertAlign: 'center',
                color: 'rgba(255, 255, 255, 0.05)',
                text: 'ProTrade AI',
            },
        });

        App.rsiSeries=App.chart.addLineSeries({color:'#a371f7',lineWidth:2, priceScaleId: 'rsi'});
        App.chart.priceScale('rsi').applyOptions({ scaleMargins: { top: 0, bottom: 0.75 } });
        App.rsiSeries.createPriceLine({price:70,color:'#f23645',lineWidth:1,lineStyle:2,axisLabelVisible:false});
        App.rsiSeries.createPriceLine({price:30,color:'#089981',lineWidth:1,lineStyle:2,axisLabelVisible:false});
        
        // -- CANDLE STYLING (Standard TradingView Colors) --
        App.cSeries=App.chart.addCandlestickSeries({
            upColor:'#089981', downColor:'#f23645',
            borderUpColor:'#089981', borderDownColor:'#f23645',
            wickUpColor:'#089981', wickDownColor:'#f23645',
            priceScaleId:'right'
        });
        
        App.chart.priceScale('right').applyOptions({ scaleMargins: { top: 0.2, bottom: 0.2 } });
        App.vSeries=App.chart.addHistogramSeries({priceFormat:{type:'volume'}, priceScaleId:'vol'});
        App.chart.priceScale('vol').applyOptions({ scaleMargins:{top:0.85, bottom:0} });
        new ResizeObserver(() => {
			App.chart.resize(d.clientWidth, d.clientHeight);
			// Yeniden boyutlandƒ±ƒüƒ±nda da son mumlara odaklƒ± kal
			const total = App.data.length;
			const bars = Math.max(100, Math.floor(d.clientWidth / 7));
			if(total > bars) {
				App.chart.timeScale().setVisibleLogicalRange({ from: total - bars, to: total });
			}
		}).observe(d);
        
        // -- CROSSHAIR FORMATTING --
        App.chart.subscribeCrosshairMove(p=>{
            if(!p.time || !App.data.length) return;
            const c = p.seriesData.get(App.cSeries); const v = p.seriesData.get(App.vSeries); const r = p.seriesData.get(App.rsiSeries);
            if(c){ 
                document.getElementById('leg-o').innerText=App.formatPrice(c.open); 
                document.getElementById('leg-h').innerText=App.formatPrice(c.high); 
                document.getElementById('leg-l').innerText=App.formatPrice(c.low); 
                document.getElementById('leg-c').innerText=App.formatPrice(c.close); 
            }
            if(v) document.getElementById('leg-v').innerText=v.value.toFixed(2); if(r) document.getElementById('leg-rsi').innerText=r.value.toFixed(2);
        });
        const bind = (id, evt, fn) => { const el = document.getElementById(id); if(el) el.addEventListener(evt, fn); };
        bind('market', 'change', (e)=>{ 
            App.loadSyms(); 
            const el = document.getElementById('crypto-scanner-area'); 
            if(el) el.style.display=e.target.value==='CRYPTO'?'block':'none'; 
            const lim = document.getElementById('limit'); 
            if(lim) lim.value = (e.target.value === 'CRYPTO') ? '500' : '200'; 
            const scanBtn = document.getElementById('scan-btn'); 
            if(scanBtn) scanBtn.innerText = `üöÄ T√úM Pƒ∞YASAYI TARA (${ASSETS[e.target.value].length})`; 
            App.autoRun(); 
        });
        bind('strategy', 'change', ()=>{ App.renderUI(); Optimizer.updateCacheUI(); App.updateHeaders(); App.autoRun(); });
        bind('symbol', 'change', App.autoRun); bind('interval', 'change', App.autoRun);
        App.loadSyms(); App.renderUI();
        document.getElementById('scan-btn').innerText = `üöÄ T√úM Pƒ∞YASAYI TARA (${ASSETS.CRYPTO.length})`;
        App.autoRun();
    },
    
    setPrecision: (lastPrice) => {
        if(!lastPrice) return;
        let p = 2;
        let minMove = 0.01;
        
        if (lastPrice > 1000) { p = 2; minMove = 0.01; }
        else if (lastPrice > 10) { p = 2; minMove = 0.01; }
        else if (lastPrice > 1) { p = 4; minMove = 0.0001; }
        else if (lastPrice > 0.01) { p = 5; minMove = 0.00001; }
        else if (lastPrice > 0.0001) { p = 6; minMove = 0.000001; }
        else { p = 8; minMove = 0.00000001; }
        
        App.currentPrecision = p;
        App.cSeries.applyOptions({
            priceFormat: {
                type: 'price',
                precision: p,
                minMove: minMove,
            },
        });
    },

    updateRealTime: (candle) => {
        if(!App.data.length) return;
        const last = App.data[App.data.length - 1];
        
        // Yeni mum mu, g√ºncelleme mi?
        // candle.time saniye cinsindendir (Binance'dan t/1000 olarak gelir)
        // E≈üitlik kontrol√º (Zamanlar tam sayƒ± saniye olarak e≈üle≈ümeli)
        if(Math.floor(candle.time) === Math.floor(last.time)) {
            // Update last candle
            App.data[App.data.length - 1] = candle;
        } else if (candle.time > last.time) {
            // New Candle
            App.data.push(candle);
            // Optional: Limit array size to prevent memory leak over very long periods
            if(App.data.length > 2500) App.data.shift();
        }

        // 1. Grafiƒüi G√ºncelle (Verimli Y√∂ntem)
        App.cSeries.update(candle);
        App.vSeries.update({ time: candle.time, value: candle.value, color: candle.color });
        
        // 2. Stratejiyi ve PnL'i Tekrar Hesapla (Sessiz Mod)
        // Her tickte tam hesaplama yapmak JS i√ßin hafiftir (500-1000 mum i√ßin)
        App.run(true); 
    },

    // --- UPDATED UI UPDATE LOGIC ---
    updateCacheInfoUI: (lastTime, cachedAt) => {
        const infoEl = document.getElementById('cache-info');
        const clearBtn = document.getElementById('clear-cache-btn');
        if(infoEl) {
            infoEl.innerText = App.formatCacheInfo(lastTime, cachedAt);
            clearBtn.style.display = 'block';
        }
    },

    autoRun: async () => {
        // LiveFeed.stop() KALDIRILDI - Artƒ±k start fonksiyonu i√ßerisinde sessizce ge√ßi≈ü yapƒ±lƒ±yor.
        // Bu sayede enstr√ºman deƒüi≈ütiƒüinde ƒ±≈üƒ±k yanƒ±p s√∂nm√ºyor.

        document.getElementById('cache-info').innerText = ''; 
        document.getElementById('clear-cache-btn').style.display = 'none';
        
        const d = await App.fetchData(); 
        if(!d||!d.length){ App.modal(false); return; }
        App.data = d;
        
        // -- SET DYNAMIC PRECISION --
        App.setPrecision(d[d.length-1].close);
        
        // ** YENƒ∞ EKLENEN KISIM: Grafiƒüi HEMEN √ßiz (Bekleme yapmadan) **
        App.cSeries.setData(d);
        App.vSeries.setData(d.map(x=>({time:x.time, value:x.value, color:x.color})));
        // --- D√úZELTME: fitContent() yerine Akƒ±llƒ± Zoom ---
        App.applySmartZoom(); 

        // ** YENƒ∞ EKLENEN KISIM: Socket'i HEMEN ba≈ülat (Optimizasyonu bekleme) **
        if(App.safeVal('market') === 'CRYPTO') {
            LiveFeed.start(App.safeVal('symbol'), App.safeVal('interval'));
        } else {
            // Eƒüer kripto deƒüilse soketi kapat (burada UI temizlenebilir)
            LiveFeed.stop();
        }

        // ≈ûimdi arka planda hesaplamayƒ± yap
        await Optimizer.runSingle(false); 
        App.updateHeaders();
    },
    formatCacheInfo: (lastTime, cachedAt) => {
        const d = new Date(lastTime * 1000); 
        const dateStr = d.toLocaleString('tr-TR', {timeZone: 'Europe/Istanbul'}); 
        const now = Date.now(); const diffMs = Math.max(0, now - cachedAt); const diffMinsTotal = Math.floor(diffMs / 60000); const hours = Math.floor(diffMinsTotal / 60); const mins = diffMinsTotal % 60;
        return `${dateStr} son mum tarihi olarak ${hours>0?'('+hours+' saat) ':''}${mins} dakika √∂nce cachelendi`;
    },
    toggleTpSlManual: () => { const check = document.getElementById('use-tpsl'); check.checked = !check.checked; App.updateTpSlUI(); },
    toggleScanOpt: () => { const check = document.getElementById('scan-tpsl-opt'); check.checked = !check.checked; },
    updateTpSlUI: () => { const check = document.getElementById('use-tpsl'); document.getElementById('tpsl-params').classList.toggle('active', check.checked); },
    openMenu: () => { document.querySelector('aside').classList.add('open'); document.getElementById('menu-backdrop').classList.add('active'); },
    closeMenu: () => { document.querySelector('aside').classList.remove('open'); document.getElementById('menu-backdrop').classList.remove('active'); },
    sTab: (id) => { document.querySelectorAll('.st-tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.sidebar-content').forEach(x=>x.classList.remove('active')); document.querySelector(`.st-tab[onclick="App.sTab('${id}')"]`).classList.add('active'); document.getElementById(`sb-${id}`).classList.add('active'); },
    updateHeaders: () => { const symFull = App.safeVal('symbol'); const sym = symFull.split('|')[0].trim(); const int = App.safeVal('interval'); const mTab = document.getElementById('tab-head-market'); if(mTab && sym) mTab.innerText = `${sym} (${int})`; const strat = App.safeVal('strategy'); const sTab = document.getElementById('tab-head-strat'); if(sTab && strat) { let pVals = []; App.paramsDef[strat].forEach(p => { const el = document.getElementById(p.id); if(el) pVals.push(el.value); }); sTab.innerText = `${strat.toUpperCase()} [${pVals.join(', ')}]`; } },
    loadSyms:()=>{ const mEl = document.getElementById('market'); const sEl = document.getElementById('symbol'); if(!mEl || !sEl) return; const m = mEl.value; sEl.innerHTML=''; ASSETS[m].forEach(x=>{let o=document.createElement('option');o.value=x.s;o.text=`${x.s} | ${x.n}`;sEl.add(o)}); },
    renderUI:()=>{ const s = App.safeVal('strategy'); const c = document.getElementById('params'); if(!c || !s) return; c.innerHTML=''; App.paramsDef[s].forEach(p=>{c.innerHTML+=`<div><label>${p.l}</label><input type="number" id="${p.id}" value="${p.v}" step="${p.s||1}" onchange="App.updateHeaders()"></div>`}); App.updateHeaders(); },
    switchTab:(t)=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); const tabEl = document.querySelector(`.tab[onclick="App.switchTab('${t}')"]`); const contentEl = document.getElementById(`tab-${t}`); if(tabEl) tabEl.classList.add('active'); if(contentEl) contentEl.classList.add('active'); },
    toast:(m,t)=>{ const el=document.getElementById('toast'); if(!el) return; el.innerText=m;el.style.color=t==='green'?'#3fb950':'#ff7b72';el.style.display='block'; setTimeout(()=>el.style.display='none',3000); },
    modal:(s,t,d,p)=>{ const m=document.getElementById('loading-overlay'); if(!m) return; if(s){ m.style.display='flex'; document.getElementById('modal-title').innerText=t; document.getElementById('modal-desc').innerText=d; document.getElementById('modal-bar').style.width=p+'%'; document.getElementById('modal-percent').innerText=Math.round(p)+'%'; }else{m.style.display='none'} },
    fetchWithProxy: async (url, idx=0) => {
        if(idx >= PROXIES.length) throw new Error("All proxies failed");
        try { const r = await fetch(PROXIES[idx] + encodeURIComponent(url)); if(!r.ok) throw new Error("Net Err"); const raw = await r.json(); return raw.contents ? JSON.parse(raw.contents) : raw; } catch(e) { return App.fetchWithProxy(url, idx+1); }
    },
    fetchData:async(so)=>{
        const m=App.safeVal('market'), s=so||App.safeVal('symbol'), t=App.safeVal('interval'), l=parseInt(App.safeVal('limit'));
        const cacheKey = `${s}_${t}`; 
        const parseInterval = (i) => { const num = parseInt(i); if(i.includes('m')) return num * 60; if(i.includes('h')) return num * 3600; if(i.includes('d')) return num * 86400; return 60; };
        if (m === 'CRYPTO') {
            const cachedWrapper = await CacheDB.get('candles', cacheKey);
            let cachedData = cachedWrapper?.candles || (Array.isArray(cachedWrapper) ? cachedWrapper : null);
            let cachedAt = cachedWrapper?.cachedAt || Date.now();
            if (cachedData?.length > 0) {
                const lastTime = cachedData[cachedData.length - 1].time;
                if(!so) App.updateCacheInfoUI(lastTime, cachedAt);
                const nowSeconds = Math.floor(Date.now() / 1000);
                if (nowSeconds < (lastTime + parseInterval(t))) return cachedData;
                const startTimeMs = (lastTime * 1000) + 1000;
                try {
                    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=${t}&limit=1000&startTime=${startTimeMs}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.length > 0) {
                            const newCandles = j.map(d=>({time:d[0]/1000,open:+d[1],high:+d[2],low:+d[3],close:+d[4],value:+d[5],color:(+d[4]>=+d[1]?'rgba(8, 153, 129, 0.3)':'rgba(242, 54, 69, 0.3)')}));
                            const finalData = cachedData.concat(newCandles).slice(-2000); 
                            const nowTs = Date.now();
                            await CacheDB.put('candles', cacheKey, { candles: finalData, cachedAt: nowTs });
                            if(!so) App.updateCacheInfoUI(finalData[finalData.length-1].time, nowTs);
                            return finalData;
                        } else return cachedData;
                    }
                } catch(e) { return cachedData; }
            }
        }
        try{
            if(m==='CRYPTO'){
                const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=${t}&limit=${l>1000?1000:l}`);
                const j = await r.json();
                const freshData = j.map(d=>({time:d[0]/1000,open:+d[1],high:+d[2],low:+d[3],close:+d[4],value:+d[5],color:(+d[4]>=+d[1]?'rgba(8, 153, 129, 0.3)':'rgba(242, 54, 69, 0.3)')}));
                const nowTs = Date.now();
                await CacheDB.put('candles', cacheKey, { candles: freshData, cachedAt: nowTs });
                if(!so) App.updateCacheInfoUI(freshData[freshData.length-1].time, nowTs);
                return freshData;
            } else {
                let iv='1d',rg='1y';if(t==='15m'){rg='1mo';iv='15m'}else if(t==='1h'||t==='2h'||t==='4h'){rg='6mo';iv='60m'}
                const j = await App.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=${iv}&range=${rg}`);
                const res=j.chart.result[0],q=res.indicators.quote[0],ts=res.timestamp;
                let d=[];for(let i=0;i<ts.length;i++){if(q.open[i]===null)continue;let o=q.open[i],c=q.close[i];d.push({time:ts[i],open:o,high:q.high[i],low:q.low[i],close:c,value:q.volume[i]||0,color:(c>=o?'rgba(8, 153, 129, 0.3)':'rgba(242, 54, 69, 0.3)')})}
                await CacheDB.put('candles', cacheKey, { candles: d, cachedAt: Date.now() });
                return d.slice(-l);
            }
        }catch(e){return App.genSim(l)}
    },
    genSim:(l)=>{let d=[],t=Math.floor(Date.now()/1000)-(l*3600),p=100;for(let i=0;i<l;i++){let m=(Math.sin(i)*3),c=p+m,o=p;d.push({time:t,open:o,high:Math.max(o,c)+1,low:Math.min(o,c)-1,close:c,value:1000,color:'rgba(8, 153, 129, 0.3)'});p=c;t+=3600}return d},
    run:async(sil=false)=>{
        if(!sil)App.modal(true,'Analiz','Veriler i≈üleniyor...',100);
        const d = App.data; if(!d || !d.length){ if(!sil)App.modal(false); return; }
        const s=App.safeVal('strategy'); const p={};
        if(App.paramsDef[s]) App.paramsDef[s].forEach(k=>{const el=document.getElementById(k.id); if(el) p[k.id]=parseFloat(el.value)});
        const useTpSl = document.getElementById('use-tpsl').checked;
        const res=Logic.backtest(d,s,p, useTpSl, parseFloat(App.safeVal('tp-val')), parseFloat(App.safeVal('sl-val')));
        
        // Sadece tam refresh'te veriyi tekrar y√ºkle
        if(!sil) {
            App.cSeries.setData(d); 
            App.vSeries.setData(d.map(x=>({time:x.time,value:x.value,color:x.color})));
            App.applySmartZoom(); // Analiz butonuna basƒ±ldƒ±ƒüƒ±nda da zoom uygula
        }

        // ƒ∞ndikat√∂rleri ve Markerlarƒ± her t√ºrl√º yenilemek lazƒ±m √ß√ºnk√º son mum deƒüi≈üti.
        App.rsiSeries.setData(Indicators.rsi(d, parseInt(App.safeVal('vis-rsi-len')) || 14));
        App.cSeries.setMarkers(res.markers.map(m => ({...m, text: `${m.text} @ ${m.price ? App.formatPrice(m.price) : ''}`})));
        
        // --- G√úNCELLEME: SON 100 MUM YAKINLA≈ûTIRMA ---
        if(!sil) {
            const totalBars = d.length;
            if (totalBars > 100) {
                App.chart.timeScale().setVisibleLogicalRange({
                    from: totalBars - 100,
                    to: totalBars
                });
            } else {
                App.chart.timeScale().fitContent();
            }
        }
        // --------------------------------------------
		
        const bal=parseFloat(App.safeVal('balance'));
        document.getElementById('res-bal').innerText='$'+(bal+res.pnl).toFixed(2);
        document.getElementById('res-pnl').innerHTML=`<span class="${res.pnl>=0?'green':'red'}">${res.pnl.toFixed(2)}</span>`;
        document.getElementById('res-win').innerText='%'+res.winRate;
        document.getElementById('res-trades').innerText=res.count; // USING CORRECT COUNT
        
        const tb=document.querySelector('#t-history tbody');
        // Tabloyu sadece canlƒ± modda deƒüilse ya da son i≈ülem deƒüi≈ümi≈üse render et (Performans i√ßin)
        // Ancak basitlik adƒ±na burada her seferinde render ediyoruz.
        if(tb) { tb.innerHTML=''; [...res.trades].reverse().forEach(t=>{ tb.innerHTML+=`<tr><td><span class="badge ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span></td><td>${new Date(t.et*1000).toLocaleString('tr-TR', {timeZone: 'Europe/Istanbul'})}</td><td>${App.formatPrice(t.ep)}</td><td>${new Date(t.xt*1000).toLocaleString('tr-TR', {timeZone: 'Europe/Istanbul'})}</td><td>${App.formatPrice(t.xp)}</td><td class="${t.pnl>=0?'green':'red'}">${t.pnl.toFixed(2)}</td><td style="font-size:0.7rem">${t.reason}</td></tr>`; }); }
        
        const ab = document.getElementById('trade-status-bar');
        if(res.openPos) {
            ab.style.display = 'flex'; const cur = d[d.length-1].close; const opnl = (res.openPos.type==='LONG'?cur-res.openPos.p:res.openPos.p-cur)*res.openPos.amt;
            document.getElementById('at-type').innerText = res.openPos.type; document.getElementById('at-type').className = `badge ${res.openPos.type==='LONG'?'b-long':'b-short'}`;
            document.getElementById('at-entry').innerText = App.formatPrice(res.openPos.p); document.getElementById('at-curr').innerText = App.formatPrice(cur);
            document.getElementById('at-pnl').innerText = `${opnl>=0?'+':''}${opnl.toFixed(2)} $`; document.getElementById('at-pnl').className = `ts-val ${opnl>=0?'green':'red'}`;
        } else ab.style.display = 'none';
        App.updateHeaders(); if(!sil)App.modal(false);
    }
};
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', App.init); else App.init();
</script>
</body>
</html>
