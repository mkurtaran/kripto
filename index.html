<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrade AI V29 - Stable Core</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --border: #30363d;
            --text-main: #e6edf3;
            --text-dim: #848d97;
            --accent: #2f81f7;
            --green: #2ea043;
            --red: #da3633;
            --rsi-color: #a371f7;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: var(--font); height: 100vh; display: flex; overflow: hidden; font-size: 13px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* SIDEBAR CONTAINER */
        aside { width: 360px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; }
        
        .header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; color: var(--text-main); background: #0d1117; }
        .header span { color: var(--accent); }

        /* SIDEBAR TABS */
        .sidebar-tabs { display: flex; background: #0d1117; border-bottom: 1px solid var(--border); overflow: hidden; }
        .st-tab { 
            flex: 1; text-align: center; padding: 12px 5px; cursor: pointer; 
            color: var(--text-dim); font-weight: 600; border-bottom: 2px solid transparent; 
            transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.8rem;
        }
        .st-tab:hover { background: #1c2128; }
        .st-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: var(--bg-panel); }

        /* SIDEBAR CONTENT PANES */
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .sidebar-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .sec-title { margin: 0 0 10px 0; font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-main); }
        select, input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: var(--text-main); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-family: var(--font); font-size: 0.85rem; }
        select:focus, input:focus { border-color: var(--accent); }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        button { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px; transition: 0.2s; }
        .btn-run { background: var(--accent); color: white; }
        .btn-run:hover { background: #58a6ff; }
        .btn-opt { background: linear-gradient(135deg, #238636, #2ea043); color: white; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-scan { background: linear-gradient(135deg, #8e44ad, #673ab7); color: white; margin-top: 10px; box-shadow: 0 4px 10px rgba(142,68,173,0.3); }
        .btn-scan:hover { filter: brightness(1.2); }
        
        .btn-blue-std { 
            background: #1f6feb; color: white; font-size: 0.8rem; padding: 10px; 
            text-align: center; border-radius: 6px; cursor: pointer; border: none; 
            font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            width: 100%; margin: 0;
        }
        .btn-blue-std:hover { background: #58a6ff; }

        /* TP/SL PANEL */
        .tp-sl-box { background: #1c2128; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-top: 15px; }
        .tp-sl-header { 
            display: flex; align-items: center; justify-content: flex-start; 
            gap: 10px; margin-bottom: 5px; cursor: pointer; user-select: none;
        }
        .tp-sl-header input[type="checkbox"] { width: auto; margin: 0; pointer-events: none; }
        .tp-sl-content { display: none; margin-top: 10px;}
        .tp-sl-content.active { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from {opacity: 0; transform: translateY(-5px);} to {opacity: 1; transform: translateY(0);} }

        /* CLICKABLE CHECKBOX ROW */
        .checkbox-row {
            margin-top: 10px; display: flex; align-items: center; gap: 10px; 
            padding: 8px 12px; background: #1c2128; border-radius: 4px; 
            cursor: pointer; user-select: none; border: 1px solid transparent;
            justify-content: flex-start;
        }
        .checkbox-row:hover { border-color: var(--border); }
        .checkbox-row input[type="checkbox"] { width: auto; margin: 0; pointer-events: none; }
        .checkbox-row label { margin: 0; font-size: 0.8rem; cursor: pointer; }

        /* OVERLAY MODAL */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: var(--bg-panel); border: 1px solid var(--border);
            width: 400px; padding: 25px; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); }
        .modal-text { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 20px; }
        
        .progress-wrapper { position: relative; height: 20px; background: #0d1117; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid var(--border); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2f81f7, #238636); width: 0%; transition: width 0.1s; }
        .progress-percent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: bold; color: white; text-shadow: 0 1px 2px black; }

        /* MAIN AREA */
        main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        
        /* CHART WRAPPER & LEGEND */
        #chart-wrap { flex: 1; position: relative; width: 100%; overflow: hidden; }
        #chart { width: 100%; height: 100%; }
        
        #chart-legend {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(13, 17, 23, 0.9); border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 6px; pointer-events: none;
            font-family: monospace; font-size: 0.85rem; color: var(--text-main);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .legend-row { display: flex; gap: 15px; margin-bottom: 2px; }
        .legend-label { color: var(--text-dim); }
        .legend-val { font-weight: 700; }
        .l-up { color: var(--green); } .l-down { color: var(--red); }

        /* STATS FOOTER */
        .stats { height: 60px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; flex-shrink: 0; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 3px; }
        .stat-val { font-size: 1.1rem; font-weight: 700; font-family: monospace; }
        .green { color: var(--green); } .red { color: var(--red); }

        /* BOTTOM PANEL */
        #bottom-panel { height: 250px; background: var(--bg-dark); display: flex; flex-direction: column; border-top: 1px solid var(--border); }
        .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: var(--text-dim); border-right: 1px solid var(--border); }
        .tab.active { background: var(--bg-dark); color: var(--text-main); border-top: 2px solid var(--accent); }
        .tab:hover { background: #21262d; }

        .tab-content { flex: 1; overflow: hidden; display: none; }
        .tab-content.active { display: block; }

        .table-wrap { height: 100%; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { position: sticky; top: 0; background: var(--bg-panel); text-align: left; padding: 8px 15px; color: var(--text-dim); border-bottom: 1px solid var(--border); z-index: 5; }
        td { padding: 6px 15px; border-bottom: 1px solid var(--border); color: var(--text-main); font-family: monospace; }
        tbody tr:hover { background: #1c2128; cursor: pointer; }

        .badge { padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; }
        .b-long { background: rgba(46, 160, 67, 0.15); color: #3fb950; border: 1px solid rgba(46, 160, 67, 0.4); }
        .b-short { background: rgba(248, 81, 73, 0.15); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4); }
        .b-open { background: rgba(56, 139, 253, 0.15); color: #58a6ff; border: 1px solid rgba(56, 139, 253, 0.4); }
        .b-neutral { background: #30363d; color: #8b949e; }

        #toast { position: absolute; top: 20px; right: 20px; background: #8b949e; color: #0d1117; padding: 12px 24px; border-radius: 6px; font-weight: 600; display: none; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        
        /* Trade Status Bar */
        #trade-status-bar {
            height: 50px; background: #1c2128; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            display: none; 
        }
        .ts-group { display: flex; align-items: center; gap: 15px; }
        .ts-label { font-size: 0.8rem; color: var(--text-dim); font-weight: 600; }
        .ts-val { font-family: monospace; font-size: 1rem; font-weight: 700; }
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">ƒ∞≈üleniyor...</div>
        <div class="progress-wrapper">
            <div class="progress-fill" id="modal-bar"></div>
            <div class="progress-percent" id="modal-percent">0%</div>
        </div>
        <div class="modal-text" id="modal-desc">L√ºtfen bekleyiniz...</div>
    </div>
</div>

<aside>
    <div class="header">ProTrade <span>AI V29</span></div>
    
    <!-- SIDEBAR TABS -->
    <div class="sidebar-tabs">
        <div class="st-tab active" id="tab-head-market" onclick="App.sTab('market')">Piyasa</div>
        <div class="st-tab" id="tab-head-strat" onclick="App.sTab('strat')">Strateji</div>
        <div class="st-tab" onclick="App.sTab('system')">Backtest</div>
    </div>

    <!-- TAB: MARKET -->
    <div id="sb-market" class="sidebar-content active">
        <div class="section">
            <div class="sec-title">Veri Kaynaƒüƒ±</div>
            <label>Piyasa Se√ßimi</label>
            <select id="market">
                <option value="CRYPTO">Kripto (Binance)</option>
                <option value="BIST">Borsa ƒ∞stanbul</option>
                <option value="US">ABD Borsasƒ±</option>
                <option value="FOREX">Forex & Emtia</option>
            </select>
            
            <label>Enstr√ºman</label>
            <select id="symbol"></select>
            
            <!-- Standardized Buttons -->
            <div class="row" style="margin-top:10px; margin-bottom:15px;">
                <button class="btn-blue-std" onclick="AssetManager.save()">Listeyi Kaydet</button>
                <label for="asset-file" class="btn-blue-std" style="margin-top:0;">Listeyi Y√ºkle</label>
                <input type="file" id="asset-file" style="display:none" onchange="AssetManager.load(this)">
            </div>

            <div class="row">
                <div>
                    <label>Periyot</label>
                    <select id="interval">
                        <option value="15m">15 Dk</option>
                        <option value="1h">1 Saat</option>
                        <option value="2h">2 Saat</option>
                        <option value="4h" selected>4 Saat</option>
                        <option value="1d">1 G√ºn</option>
                    </select>
                </div>
                <div>
                    <label>Mum Sayƒ±sƒ±</label>
                    <select id="limit">
                        <option value="200">200</option>
                        <option value="500" selected>500</option>
                        <option value="1000">1000</option>
                        <option value="2000">2000</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div>
                    <label>Yenileme</label>
                    <select id="refresh">
                        <option value="0">Manuel</option>
                        <option value="5000">5 Sn</option>
                        <option value="15000">15 Sn</option>
                        <option value="60000">1 Dk</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-run" onclick="App.run()">Analiz Et</button>
        </div>
    </div>

    <!-- TAB: STRATEGY -->
    <div id="sb-strat" class="sidebar-content">
        <div class="section">
            <div class="sec-title">Algoritma (Backtest)</div>
            <select id="strategy">
                <option value="supertrend">SuperTrend</option>
                <option value="psar">Parabolic SAR</option>
                <option value="stoch">Stochastic</option>
                <option value="turtle">Turtle Trading</option>
                <option value="emacross">EMA Cross</option>
            </select>
            <div id="params"></div>
            
            <!-- TP / SL MODULE (FIXED CLICK) -->
            <div class="tp-sl-box">
                <div class="tp-sl-header" onclick="App.toggleTpSlManual()">
                    <input type="checkbox" id="use-tpsl">
                    <label style="margin:0; cursor:pointer; font-weight:700;">Kar Al / Zarar Durdur</label>
                </div>
                <div class="tp-sl-content" id="tpsl-params">
                    <div class="row">
                        <div>
                            <label>Kar Al (%)</label>
                            <input type="number" id="tp-val" value="3.0" step="0.1">
                        </div>
                        <div>
                            <label>Stop (%)</label>
                            <input type="number" id="sl-val" value="1.5" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="sec-title">Optimizasyon</div>
            <button class="btn-opt" onclick="Optimizer.runSingle()">‚ö° En ƒ∞yi Parametreleri Bul</button>
        </div>

        <div class="section">
            <div class="sec-title">G√∂rsel ƒ∞ndikat√∂rler</div>
            <label>RSI Periyodu</label>
            <input type="number" id="vis-rsi-len" value="14">
        </div>
    </div>

    <!-- TAB: BACKTEST (SYSTEM) -->
    <div id="sb-system" class="sidebar-content">
        <div class="section">
            <div class="sec-title">Piyasa Tarayƒ±cƒ±</div>
            <div id="crypto-scanner-area">
                <button class="btn-scan" id="scan-btn" onclick="Scanner.start()">üöÄ T√úM Pƒ∞YASAYI TARA</button>
                
                <!-- Fixed Checkbox Alignment & Click -->
                <div class="checkbox-row" onclick="App.toggleScanOpt()">
                    <input type="checkbox" id="scan-tpsl-opt">
                    <label>TP/SL Dahil Optimize Et</label>
                </div>

                <div style="text-align:center; font-size:0.7rem; color:#8b949e; margin-top:10px;" id="last-scan-time"></div>
            </div>
        </div>

        <div class="section">
            <div class="sec-title">Sermaye Y√∂netimi</div>
            <label>Bakiye ($)</label>
            <input type="number" id="balance" value="1000">
        </div>

        <div class="section">
            <div class="sec-title">Veri Y√∂netimi</div>
            <div class="row">
                <button class="btn-blue-std" onclick="ConfigManager.save()">üì• Tarama Verilerini ƒ∞ndir</button>
                <label for="file-input" class="btn-blue-std" style="margin-top:0;">üì§ Veri Geri Y√ºkle</label>
                <input type="file" id="file-input" style="display:none" onchange="ConfigManager.load(this)">
            </div>
            <div style="font-size:0.7rem; color:#848d97; margin-top:5px;">Not: Sadece tamamlanmƒ±≈ü tarama sonu√ßlarƒ± indirilir.</div>
        </div>
    </div>
</aside>

<main>
    <div id="toast"></div>

    <!-- Active Trade Status -->
    <div id="trade-status-bar">
        <div class="ts-group">
            <span class="badge b-open" id="at-type">LONG</span>
            <div>
                <div class="ts-label">Giri≈ü</div>
                <div class="ts-val" id="at-entry">0.00</div>
            </div>
            <div>
                <div class="ts-label">Anlƒ±k</div>
                <div class="ts-val" id="at-curr">0.00</div>
            </div>
        </div>
        <div class="ts-group">
            <div style="text-align:right">
                <div class="ts-label">Anlƒ±k K√¢r/Zarar</div>
                <div class="ts-val" id="at-pnl">0.00 $</div>
            </div>
        </div>
    </div>

    <div id="chart-wrap">
        <div id="chart-legend">
            <div class="legend-row">
                <span class="legend-label">O:</span><span class="legend-val" id="leg-o">--</span>
                <span class="legend-label">H:</span><span class="legend-val" id="leg-h">--</span>
                <span class="legend-label">L:</span><span class="legend-val" id="leg-l">--</span>
                <span class="legend-label">C:</span><span class="legend-val" id="leg-c">--</span>
            </div>
            <div class="legend-row">
                <span class="legend-label">Vol:</span><span class="legend-val" id="leg-v">--</span>
                <span class="legend-label" style="margin-left:10px; color:var(--rsi-color)">RSI:</span><span class="legend-val" id="leg-rsi">--</span>
            </div>
        </div>
        <div id="chart"></div>
    </div>
    
    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">Toplam Varlƒ±k</div>
            <div class="stat-val" id="res-bal">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Toplam PnL</div>
            <div class="stat-val" id="res-pnl">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Ba≈üarƒ± %</div>
            <div class="stat-val" id="res-win">---</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ƒ∞≈ülem Adedi</div>
            <div class="stat-val" id="res-trades">---</div>
        </div>
    </div>

    <!-- BOTTOM PANEL -->
    <div id="bottom-panel">
        <div class="tabs">
            <div class="tab active" onclick="App.switchTab('history')">ƒ∞≈ülem Ge√ßmi≈üi</div>
            <div class="tab" onclick="App.switchTab('scanner')">üîç Tarama Sonu√ßlarƒ±</div>
        </div>
        
        <!-- HISTORY -->
        <div id="tab-history" class="tab-content active">
            <div class="table-wrap">
                <table id="t-history">
                    <thead><tr><th>Tip</th><th>Giri≈ü</th><th>Fiyat</th><th>√áƒ±kƒ±≈ü</th><th>Fiyat</th><th>PnL</th><th>Neden</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- SCANNER -->
        <div id="tab-scanner" class="tab-content">
            <div class="table-wrap">
                <table id="t-scanner">
                    <thead><tr><th>Sembol</th><th>Son ƒ∞≈ülem</th><th>Sinyal</th><th>PnL ($)</th><th>Win Rate</th><th>ƒ∞≈ülem</th><th>Durum</th></tr></thead>
                    <tbody><tr><td colspan="7" style="text-align:center; padding:20px; color:#8b949e;">Tarama yapƒ±lmadƒ± veya veri y√ºklenmedi.</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
/* --- 1. DATA CONFIG --- */
let ASSETS = {
    CRYPTO: [
        {s:'BTCUSDT',n:'Bitcoin'},{s:'ETHUSDT',n:'Ethereum'},{s:'BNBUSDT',n:'Binance Coin'},{s:'SOLUSDT',n:'Solana'},
        {s:'XRPUSDT',n:'Ripple'},{s:'ADAUSDT',n:'Cardano'},{s:'AVAXUSDT',n:'Avalanche'},{s:'DOGEUSDT',n:'Dogecoin'},
        {s:'DOTUSDT',n:'Polkadot'},{s:'TRXUSDT',n:'Tron'},{s:'MATICUSDT',n:'Polygon'},{s:'LTCUSDT',n:'Litecoin'},
        {s:'SHIBUSDT',n:'Shiba'},{s:'ATOMUSDT',n:'Cosmos'},{s:'LINKUSDT',n:'Chainlink'},{s:'UNIUSDT',n:'Uniswap'},
        {s:'XLMUSDT',n:'Stellar'},{s:'ETCUSDT',n:'Ethereum Classic'},{s:'FILUSDT',n:'Filecoin'},{s:'APTUSDT',n:'Aptos'},
        {s:'ARBUSDT',n:'Arbitrum'},{s:'NEARUSDT',n:'Near'},{s:'QNTUSDT',n:'Quant'},{s:'VETUSDT',n:'VeChain'},
        {s:'MKRUSDT',n:'Maker'},{s:'GRTUSDT',n:'The Graph'},{s:'RNDRUSDT',n:'Render'},{s:'SNXUSDT',n:'Synthetix'},
        {s:'THETAUSDT',n:'Theta'},{s:'SANDUSDT',n:'Sandbox'},{s:'MANAUSDT',n:'Decentraland'},{s:'AAVEUSDT',n:'Aave'}
    ],
    BIST: [{s:'THYAO.IS',n:'THY'},{s:'ASELS.IS',n:'Aselsan'},{s:'GARAN.IS',n:'Garanti'},{s:'AKBNK.IS',n:'Akbank'},{s:'SISE.IS',n:'≈ûi≈üecam'},{s:'KCHOL.IS',n:'Ko√ß'},{s:'SAHOL.IS',n:'Sabancƒ±'},{s:'EREGL.IS',n:'Ereƒüli'},{s:'TUPRS.IS',n:'T√ºpra≈ü'},{s:'BIMAS.IS',n:'Bƒ∞M'},{s:'ISCTR.IS',n:'ƒ∞≈ü Bankasƒ±'},{s:'YKBNK.IS',n:'Yapƒ± Kredi'},{s:'FROTO.IS',n:'Ford Otosan'},{s:'TOASO.IS',n:'Tofa≈ü'},{s:'TCELL.IS',n:'Turkcell'},{s:'SASA.IS',n:'SASA'},{s:'HEKTS.IS',n:'Hekta≈ü'},{s:'PETKM.IS',n:'Petkim'},{s:'EKGYO.IS',n:'Emlak Konut'},{s:'ODAS.IS',n:'Oda≈ü'},{s:'KOZAL.IS',n:'Koza'},{s:'KRDMD.IS',n:'Kardemir D'},{s:'ASTOR.IS',n:'Astor'},{s:'ENKAI.IS',n:'Enka'},{s:'ALARK.IS',n:'Alarko'},{s:'GUBRF.IS',n:'G√ºbre Fab.'},{s:'VESTL.IS',n:'Vestel'},{s:'ARCLK.IS',n:'Ar√ßelik'}],
    US: [{s:'AAPL',n:'Apple'},{s:'MSFT',n:'Microsoft'},{s:'NVDA',n:'Nvidia'},{s:'TSLA',n:'Tesla'},{s:'AMZN',n:'Amazon'},{s:'GOOGL',n:'Google'},{s:'META',n:'Meta'},{s:'AMD',n:'AMD'},{s:'NFLX',n:'Netflix'},{s:'INTC',n:'Intel'},{s:'BABA',n:'Alibaba'},{s:'PYPL',n:'PayPal'},{s:'CRM',n:'Salesforce'},{s:'ADBE',n:'Adobe'},{s:'CSCO',n:'Cisco'},{s:'JPM',n:'JPMorgan'},{s:'V',n:'Visa'},{s:'WMT',n:'Walmart'},{s:'PG',n:'Procter & Gamble'},{s:'XOM',n:'Exxon Mobil'}],
    FOREX: [{s:'EURUSD=X',n:'EUR/USD'},{s:'GBPUSD=X',n:'GBP/USD'},{s:'USDJPY=X',n:'USD/JPY'},{s:'USDTRY=X',n:'USD/TRY'},{s:'GC=F',n:'Gold'},{s:'SI=F',n:'Silver'},{s:'CL=F',n:'Crude Oil'},{s:'NG=F',n:'Natural Gas'},{s:'HG=F',n:'Copper'},{s:'PL=F',n:'Platinum'},{s:'PA=F',n:'Palladium'}]
};

const PROXIES = [
    'https://api.allorigins.win/raw?url=',
    'https://corsproxy.io/?',
    'https://thingproxy.freeboard.io/fetch/'
];

/* --- 2. ASSET MANAGER --- */
const AssetManager = {
    save: () => {
        const b = new Blob([JSON.stringify(ASSETS)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ProTrade_AssetList.json'; a.click();
        App.toast('Enstr√ºman listesi indirildi', 'green');
    },
    load: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                ASSETS = JSON.parse(e.target.result);
                App.loadSyms();
                App.toast('Enstr√ºman listesi g√ºncellendi', 'green');
            } catch(e) { App.toast('Dosya hatasƒ±', 'red'); }
            input.value = '';
        };
        r.readAsText(f);
    }
};

/* --- 3. INDICATORS --- */
const Indicators = {
    superTrend:(d,p,f)=>{let r=[],tr=[0];for(let i=1;i<d.length;i++)tr.push(Math.max(d[i].high-d[i].low,Math.abs(d[i].high-d[i-1].close),Math.abs(d[i].low-d[i-1].close)));let a=new Array(d.length).fill(0),s=0;for(let i=0;i<p;i++)s+=tr[i];a[p-1]=s/p;for(let i=p;i<d.length;i++)a[i]=(a[i-1]*(p-1)+tr[i])/p;let dir=1;for(let i=0;i<d.length;i++){if(i<p){r.push({d:1});continue}let m=(d[i].high+d[i].low)/2,bu=m+f*a[i],bl=m-f*a[i],pu=r[i-1].u||bu,pl=r[i-1].l||bl,fu=(bu<pu||d[i-1].close>pu)?bu:pu,fl=(bl>pl||d[i-1].close<pl)?bl:pl;if(r[i-1].d===1&&d[i].close<fl)dir=-1;else if(r[i-1].d===-1&&d[i].close>fu)dir=1;else dir=r[i-1].d;let sig=null;if(dir===1&&r[i-1].d===-1)sig='LONG';if(dir===-1&&r[i-1].d===1)sig='SHORT';r.push({d:dir,u:fu,l:fl,s:sig});}return r;},
    psar:(d,s,i,m)=>{let r=new Array(d.length).fill({}),l=true,a=s,sar=d[0].low,ep=d[0].high;for(let k=1;k<d.length;k++){sar=sar+a*(ep-sar);if(l){if(d[k].low<sar){l=false;sar=ep;ep=d[k].low;a=s}else{if(d[k].high>ep){ep=d[k].high;a=Math.min(a+i,m)}}}else{if(d[k].high>sar){l=true;sar=ep;ep=d[k].high;a=s}else{if(d[k].low<ep){ep=d[k].low;a=Math.min(a+i,m)}}}let sig=null;if(l&&!r[k-1].l)sig='LONG';if(!l&&r[k-1].l)sig='SHORT';r[k]={sar,l,s:sig};}return r;},
    stoch:(d,kP,dP)=>{let r=[],k=[],l=0,h=0;for(let i=0;i<d.length;i++){if(i<kP){r.push({k:50,s:null});continue}let sl=d.slice(i-kP+1,i+1);l=Math.min(...sl.map(x=>x.low));h=Math.max(...sl.map(x=>x.high));k.push(((d[i].close-l)/(h-l))*100);}let dL=[];for(let i=0;i<k.length;i++){if(i<dP){dL.push(50);continue}let s=0;for(let j=0;j<dP;j++)s+=k[i-j];dL.push(s/dP);}return k.map((v,i)=>{let sig=null;if(i>0){if(v>dL[i]&&k[i-1]<=dL[i-1]&&v<20)sig='LONG';if(v<dL[i]&&k[i-1]>=dL[i-1]&&v>80)sig='SHORT'}return{s:sig,k:v};});},
    turtle:(d,e,x)=>{let r=[];for(let i=0;i<d.length;i++){if(i<e){r.push({s:null});continue}let h=Math.max(...d.slice(i-e,i).map(z=>z.high)),l=Math.min(...d.slice(i-e,i).map(z=>z.low));let s=null;if(d[i].close>h)s='LONG';if(d[i].close<l)s='SHORT';r.push({s});}return r;},
    emaCross:(d,f,s)=>{const ema=(a,p)=>{let r=[],k=2/(p+1),e=a[0].close;a.forEach(z=>{e=z.close*k+e*(1-k);r.push(e)});return r};let ef=ema(d,f),es=ema(d,s);return ef.map((v,i)=>{let sig=null;if(i>0){if(v>es[i]&&ef[i-1]<=es[i-1])sig='LONG';if(v<es[i]&&ef[i-1]>=es[i-1])sig='SHORT'}return{s:sig}})},
    rsi:(d,p)=>{let r=[],g=0,l=0;for(let i=0;i<d.length;i++){if(i===0){r.push({time:d[i].time,value:50});continue}let c=d[i].close-d[i-1].close;let ug=c>0?c:0,ul=c<0?-c:0;if(i<p){g+=ug;l+=ul;r.push({time:d[i].time,value:50})}else if(i===p){g/=p;l/=p;r.push({time:d[i].time,value:100-(100/(1+g/l))})}else{g=(g*(p-1)+ug)/p;l=(l*(p-1)+ul)/p;r.push({time:d[i].time,value:l===0?100:100-(100/(1+g/l))})}}return r;}
};

/* --- 4. LOGIC ENGINE (MOVED UP FOR SAFETY) --- */
const Logic={
    backtest:(d,st,p, useTpSl=false, tpPct=0, slPct=0)=>{
        let sigs=[];
        if(st==='supertrend')sigs=Indicators.superTrend(d,p.st_p,p.st_f).map(x=>x.s);
        if(st==='psar')sigs=Indicators.psar(d,p.ps_s,p.ps_i,p.ps_m).map(x=>x.s);
        if(st==='stoch')sigs=Indicators.stoch(d,p.st_k,p.st_d).map(x=>x.s);
        if(st==='turtle')sigs=Indicators.turtle(d,p.tt_in,p.tt_out).map(x=>x.s);
        if(st==='emacross')sigs=Indicators.emaCross(d,p.ema_f,p.ema_s).map(x=>x.s);
        
        let tr=[],mk=[],pos=null,w=0,bal=parseFloat(App.safeVal('balance') || 1000),ls=null;
        
        for(let i=1;i<d.length;i++){
            let s=sigs[i]; if(s)ls=s;
            let current = d[i];
            
            // TP/SL Checks (Intra-candle)
            if(pos && useTpSl) {
                let exitPrice = null; let reason = '';
                if(pos.type === 'LONG') {
                    const stopPrice = pos.p * (1 - slPct/100);
                    const targetPrice = pos.p * (1 + tpPct/100);
                    if (current.low <= stopPrice) { exitPrice = stopPrice; reason = 'Stop Loss'; } 
                    else if (current.high >= targetPrice) { exitPrice = targetPrice; reason = 'Take Profit'; }
                } 
                else if (pos.type === 'SHORT') {
                    const stopPrice = pos.p * (1 + slPct/100);
                    const targetPrice = pos.p * (1 - tpPct/100);
                    if (current.high >= stopPrice) { exitPrice = stopPrice; reason = 'Stop Loss'; } 
                    else if (current.low <= targetPrice) { exitPrice = targetPrice; reason = 'Take Profit'; }
                }

                if (exitPrice) {
                    let pnl = (pos.type==='LONG' ? exitPrice - pos.p : pos.p - exitPrice) * pos.amt;
                    if(pnl>0) w++;
                    tr.push({type:pos.type,et:pos.t,ep:pos.p,xt:current.time,xp:exitPrice,pnl,reason});
                    mk.push({time:current.time,position:pos.type==='LONG'?'aboveBar':'belowBar',color:reason==='Take Profit'?'#2ea043':'#da3633',shape:'circle',text:reason,price:exitPrice});
                    pos = null;
                    continue; 
                }
            }

            // Strategy Exit
            if(pos) {
                if((pos.type==='LONG'&&s==='SHORT')||(pos.type==='SHORT'&&s==='LONG')){
                    let pnl=(pos.type==='LONG'?current.close-pos.p:pos.p-current.close)*pos.amt;
                    if(pnl>0)w++;
                    tr.push({type:pos.type,et:pos.t,ep:pos.p,xt:current.time,xp:current.close,pnl,reason:'Sinyal'});
                    mk.push({time:current.time,position:pos.type==='LONG'?'aboveBar':'belowBar',color:'#848d97',shape:'circle',text:'Exit',price:current.close});
                    pos=null;
                }
            }

            // Strategy Entry
            if(!pos&&s){
                pos={type:s,p:current.close,t:current.time,amt:bal/current.close};
                mk.push({time:current.time,position:s==='LONG'?'belowBar':'aboveBar',color:s==='LONG'?'#238636':'#da3633',shape:s==='LONG'?'arrowUp':'arrowDown',text:s,price:current.close});
            }
        }
        return {trades:tr,markers:mk,pnl:tr.reduce((a,b)=>a+b.pnl,0),winRate:tr.length?Math.round((w/tr.length)*100):0,openPos:pos,lastSignal:ls}
    }
};

/* --- 5. CONFIG MANAGER --- */
const ConfigManager={
    save:()=>{
        if(!Scanner.results || Object.keys(Scanner.results).length === 0) { App.toast('Hata: √ñnce T√úM Pƒ∞YASAYI TARA i≈ülemini tamamlayƒ±n!', 'red'); return; }
        const c={
            market:App.safeVal('market'),symbol:App.safeVal('symbol'),interval:App.safeVal('interval'),limit:App.safeVal('limit'),strategy:App.safeVal('strategy'),balance:App.safeVal('balance'),visRsi:App.safeVal('vis-rsi-len'),scanRes:Scanner.results,
            useTpSl: document.getElementById('use-tpsl').checked,
            tpVal: App.safeVal('tp-val'), slVal: App.safeVal('sl-val'),
            params:{},timestamp: new Date().toISOString()
        };
        const s=App.safeVal('strategy'); if(s){App.paramsDef[s].forEach(p=>c.params[p.id]=App.safeVal(p.id));}
        const d = new Date(); const dateStr = d.toISOString().split('T')[0] + '_' + d.toTimeString().split(' ')[0].replace(/:/g,'-').slice(0,5);
        const fname = `ProTrade_ScanResult_${dateStr}.json`;
        const b=new Blob([JSON.stringify(c)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=fname; a.click();
        App.toast('Tarama sonu√ßlarƒ± kaydedildi.','green');
    },
    load:(input)=>{
        const f=input.files[0]; if(!f) return; const r=new FileReader();
        r.onload=(e)=>{try{
            const c=JSON.parse(e.target.result);
            if(document.getElementById('market')) { document.getElementById('market').value=c.market; App.loadSyms(); }
            if(document.getElementById('interval')) document.getElementById('interval').value=c.interval;
            if(document.getElementById('limit')) document.getElementById('limit').value=c.limit;
            if(document.getElementById('strategy')) document.getElementById('strategy').value=c.strategy;
            if(document.getElementById('balance')) document.getElementById('balance').value=c.balance;
            if(document.getElementById('vis-rsi-len')) document.getElementById('vis-rsi-len').value=c.visRsi||14;
            
            if(c.useTpSl !== undefined) {
                document.getElementById('use-tpsl').checked = c.useTpSl;
                document.getElementById('tp-val').value = c.tpVal;
                document.getElementById('sl-val').value = c.slVal;
                App.toggleTpSlManual(); // Refresh UI
            }

            App.renderUI();
            for(let k in c.params) if(document.getElementById(k)) document.getElementById(k).value=c.params[k];
            
            if(c.scanRes){ Scanner.results=c.scanRes; Scanner.renderResults(); App.switchTab('scanner'); App.toast('Tarama verileri y√ºklendi.','green'); } 
            else { App.toast('Dosyada tarama verisi yok!','red'); }
            App.updateHeaders();
        }catch(x){ console.error(x); App.toast('Dosya formatƒ± hatalƒ±!','red'); } input.value = '';};
        r.readAsText(f);
    }
};

/* --- 6. CORE OPTIMIZER ENGINE (UNIFIED) --- */
const Optimizer={
    // Shared Strategy Variations
    getV:(s)=>{let v=[];
        if(s==='supertrend')for(let p=5;p<40;p+=2)for(let f=1;f<6;f+=0.5)v.push({st_p:p,st_f:f});
        if(s==='psar')for(let x=0.01;x<0.05;x+=0.01)v.push({ps_s:x,ps_i:x,ps_m:0.2});
        if(s==='stoch')for(let k=5;k<30;k+=2)for(let d=2;d<10;d+=1)v.push({st_k:k,st_d:d});
        if(s==='turtle')for(let i=10;i<50;i+=5)for(let o=5;o<25;o+=2)if(i>o)v.push({tt_in:i,tt_out:o});
        if(s==='emacross')for(let f=5;f<30;f+=2)for(let sl=10;sl<100;sl+=5)if(sl>f)v.push({ema_f:f,ema_s:sl});
        return v;
    },

    // CENTRAL OPTIMIZATION LOGIC (Shared by Single & Scanner)
    optimizeSymbol: async (data, strat, useTpSl, updateCallback) => {
        const v = Optimizer.getV(strat); 
        
        // Define TP/SL Ranges based on flag
        const tpRanges = useTpSl ? [1.5, 3.0, 5.0, 8.0] : [0];
        const slRanges = useTpSl ? [1.0, 2.0, 4.0] : [0];

        // Flatten into simple array of test cases
        let testCases = [];
        for(const p of v) {
            for(const tp of tpRanges) {
                for(const sl of slRanges) {
                    testCases.push({p, tp, sl});
                }
            }
        }

        let best = -Infinity; 
        let bestResult = null;
        
        // Batch Process
        const BATCH = 500; 
        for(let i=0; i<testCases.length; i+=BATCH){
            const slice = testCases.slice(i, i+BATCH);
            for(const c of slice) {
                // Pass specific TP/SL to backtest engine
                const isTpSlActive = c.tp > 0 || c.sl > 0; 
                const r = Logic.backtest(data, strat, c.p, isTpSlActive, c.tp, c.sl);
                
                if(r.pnl > best) { 
                    best = r.pnl; 
                    bestResult = {
                        p: c.p, 
                        tp: c.tp, 
                        sl: c.sl, 
                        stats: r
                    }; 
                }
            }
            if(updateCallback) updateCallback((i/testCases.length)*100);
            await new Promise(r=>setTimeout(r,0)); // Yield to UI
        }
        
        return bestResult;
    },

    // Single Asset Optimization
    runSingle:async()=>{
        const s=App.safeVal('strategy'),d=App.data;if(!d.length)return;
        const useTpSl = document.getElementById('use-tpsl').checked;

        App.modal(true,'Optimize','Hesaplanƒ±yor...',0); await new Promise(r=>setTimeout(r,100));

        // Use Shared Logic
        const res = await Optimizer.optimizeSymbol(d, s, useTpSl, (pct) => {
             App.modal(true,'Optimize','Taranƒ±yor...', pct);
        });

        if(res){
            const bp = res.p;
            for(let k in bp) if(document.getElementById(k)) document.getElementById(k).value=bp[k];
            
            if(useTpSl) {
                document.getElementById('tp-val').value = res.tp;
                document.getElementById('sl-val').value = res.sl;
            }
            App.toast(`Optimum: $${res.stats.pnl.toFixed(2)}`,'green');
            App.run(true);
        }
        App.modal(false);
    }
};

const Scanner={
    results:{},
    start:async()=>{
        const s=App.safeVal('strategy'), syms=ASSETS.CRYPTO;
        const useTpSl = document.getElementById('scan-tpsl-opt').checked;

        App.modal(true,'Tarama','Ba≈ülƒ±yor...',0); Scanner.results={};
        
        for(let i=0;i<syms.length;i++){
            const symName = syms[i].s;
            App.modal(true,`Taranƒ±yor: ${symName}`,`${i+1}/${syms.length}`,(i/syms.length)*100);
            
            let d = null; try { d = await App.fetchData(symName); } catch(e) { console.error(e); }

            if(d&&d.length>50){
                // USE SHARED LOGIC
                const optRes = await Optimizer.optimizeSymbol(d, s, useTpSl, null);
                
                if(optRes) {
                    const run = optRes.stats;
                    let lastT = run.openPos ? run.openPos.t : (run.trades.length>0 ? run.trades[run.trades.length-1].et : 0);
                    
                    Scanner.results[symName]={
                        bestParams: optRes.p, 
                        bestTp: optRes.tp, 
                        bestSl: optRes.sl, 
                        pnl: run.pnl, 
                        winRate: run.winRate, 
                        trades: run.trades.length, 
                        lastSignal: run.lastSignal, 
                        openPos: run.openPos, 
                        lastEntryTime: lastT
                    };
                }
            }
        }
        App.modal(false); Scanner.renderResults(); App.switchTab('scanner');
    },
    renderResults:()=>{
        const tb=document.querySelector('#t-scanner tbody'); if(!tb) return; tb.innerHTML='';
        const keys=Object.keys(Scanner.results).sort((a,b)=>Scanner.results[b].lastEntryTime - Scanner.results[a].lastEntryTime);
        keys.forEach(k=>{
            const r=Scanner.results[k];
            let st=`<span class="badge b-neutral">Beklemede</span>`;
            if(r.openPos)st=`<span class="badge ${r.openPos.type==='LONG'?'b-long':'b-short'}">A√áIK: ${r.openPos.type}</span>`;
            else if(r.lastSignal)st=`<span class="badge ${r.lastSignal==='LONG'?'b-long':'b-short'}">Sinyal: ${r.lastSignal}</span>`;
            const dateStr = r.lastEntryTime>0 ? new Date(r.lastEntryTime*1000).toLocaleString() : '-';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td><b>${k}</b></td><td style="font-size:0.75rem">${dateStr}</td><td>${st}</td><td class="${r.pnl>=0?'green':'red'}">${r.pnl.toFixed(2)}</td><td>%${r.winRate}</td><td>${r.trades}</td><td><button class="btn-blue-std" style="padding:2px 6px; width:auto;" onclick="Scanner.load('${k}')">Se√ß</button></td>`;
            tb.appendChild(tr);
        });
    },
    load:(s)=>{
        const symEl = document.getElementById('symbol');
        if(symEl) {
            symEl.value=s;
            if(Scanner.results[s]){
                const res=Scanner.results[s];
                const b=res.bestParams;
                for(let k in b) if(document.getElementById(k)) document.getElementById(k).value=b[k];
                // Apply Optimized TP/SL to UI if they exist (non-zero)
                if(res.bestTp !== undefined && (res.bestTp > 0 || res.bestSl > 0)) {
                    document.getElementById('use-tpsl').checked = true;
                    App.updateTpSlUI(); // Ensure visibility
                    document.getElementById('tp-val').value = res.bestTp;
                    document.getElementById('sl-val').value = res.bestSl;
                } else {
                     if(res.bestTp === 0 && res.bestSl === 0) {
                         document.getElementById('use-tpsl').checked = false;
                         App.updateTpSlUI();
                     }
                }
            }
            App.run();
            App.switchTab('history');
        }
    }
};

/* --- 7. APP CONTROLLER (MOVED DOWN) --- */
const App = {
    chart:null, cSeries:null, vSeries:null, rsiSeries:null, data:[], intervalId:null,
    paramsDef:{supertrend:[{id:'st_p',l:'Periyot',v:10},{id:'st_f',l:'Fakt√∂r',v:3,s:0.1}],psar:[{id:'ps_s',l:'Ba≈ülangƒ±√ß',v:0.02,s:0.01},{id:'ps_i',l:'Adƒ±m',v:0.02,s:0.01},{id:'ps_m',l:'Max',v:0.2,s:0.01}],stoch:[{id:'st_k',l:'K',v:14},{id:'st_d',l:'D',v:3}],turtle:[{id:'tt_in',l:'Giri≈ü',v:20},{id:'tt_out',l:'√áƒ±kƒ±≈ü',v:10}],emacross:[{id:'ema_f',l:'Fast',v:9},{id:'ema_s',l:'Slow',v:21}]},
    
    safeVal: (id) => { const el = document.getElementById(id); return el ? el.value : ''; },

    init:()=>{
        const d=document.getElementById('chart'); if(!d) return;
        App.chart=LightweightCharts.createChart(d,{layout:{background:{color:'#0d1117'},textColor:'#848d97'},grid:{vertLines:{color:'#161b22'},horzLines:{color:'#161b22'}},timeScale:{borderColor:'#30363d',timeVisible:true},rightPriceScale:{borderColor:'#30363d'}});
        App.rsiSeries=App.chart.addLineSeries({color:'#a371f7',lineWidth:2, priceScaleId: 'rsi'});
        App.chart.priceScale('rsi').applyOptions({ scaleMargins: { top: 0, bottom: 0.75 } });
        App.rsiSeries.createPriceLine({price:70,color:'#da3633',lineWidth:1,lineStyle:2,axisLabelVisible:false});
        App.rsiSeries.createPriceLine({price:30,color:'#238636',lineWidth:1,lineStyle:2,axisLabelVisible:false});
        App.cSeries=App.chart.addCandlestickSeries({upColor:'#238636',downColor:'#da3633',borderVisible:false,wickUpColor:'#238636',wickDownColor:'#da3633',priceScaleId:'right'});
        App.chart.priceScale('right').applyOptions({ scaleMargins: { top: 0.3, bottom: 0.15 } });
        App.vSeries=App.chart.addHistogramSeries({priceFormat:{type:'volume'}, priceScaleId:'vol'});
        App.chart.priceScale('vol').applyOptions({ scaleMargins:{top:0.85, bottom:0} });
        new ResizeObserver(()=>App.chart.resize(d.clientWidth,d.clientHeight)).observe(d);
        
        App.chart.subscribeCrosshairMove(p=>{
            if(!p.time || !App.data.length) return;
            const c = p.seriesData.get(App.cSeries); const v = p.seriesData.get(App.vSeries); const r = p.seriesData.get(App.rsiSeries);
            if(c){ document.getElementById('leg-o').innerText=c.open.toFixed(2); document.getElementById('leg-h').innerText=c.high.toFixed(2); document.getElementById('leg-l').innerText=c.low.toFixed(2); document.getElementById('leg-c').innerText=c.close.toFixed(2); }
            if(v) document.getElementById('leg-v').innerText=v.value.toFixed(2);
            if(r) document.getElementById('leg-rsi').innerText=r.value.toFixed(2);
        });

        const bind = (id, evt, fn) => { const el = document.getElementById(id); if(el) el.addEventListener(evt, fn); };
        bind('market', 'change', (e)=>{ 
            App.loadSyms(); 
            const el = document.getElementById('crypto-scanner-area'); 
            if(el) el.style.display=e.target.value==='CRYPTO'?'block':'none'; 
            App.updateHeaders(); 
            // Auto update limits
            const lim = document.getElementById('limit');
            if(lim) lim.value = (e.target.value === 'CRYPTO') ? '500' : '200';
            // Button text update
            const scanBtn = document.getElementById('scan-btn');
            if(scanBtn) scanBtn.innerText = `üöÄ T√úM Pƒ∞YASAYI TARA (${ASSETS[e.target.value].length})`;
        });
        bind('strategy', 'change', ()=>{ App.renderUI(); App.updateHeaders(); });
        bind('symbol', 'change', ()=>{ const val = App.safeVal('symbol'); if(Scanner.results[val]){ 
            const res = Scanner.results[val];
            const b = res.bestParams;
            for(let k in b) if(document.getElementById(k)) document.getElementById(k).value=b[k]; 
            // Apply Optimized TP/SL to UI if they exist (non-zero)
            if(res.bestTp !== undefined && (res.bestTp > 0 || res.bestSl > 0)) {
                document.getElementById('use-tpsl').checked = true;
                App.updateTpSlUI(); // Ensure visibility
                document.getElementById('tp-val').value = res.bestTp;
                document.getElementById('sl-val').value = res.bestSl;
            } else {
                 if(res.bestTp === 0 && res.bestSl === 0) {
                     document.getElementById('use-tpsl').checked = false;
                     App.updateTpSlUI();
                 }
            }
            App.toast('Optimize Ayarlar','green'); } App.run(); App.updateHeaders(); });
        bind('interval', 'change', App.updateHeaders);
        bind('refresh', 'change', App.setTimer);

        App.loadSyms(); App.renderUI(); App.setTimer(); App.run(); App.updateHeaders();
        // Init Button Text
        document.getElementById('scan-btn').innerText = `üöÄ T√úM Pƒ∞YASAYI TARA (${ASSETS.CRYPTO.length})`;
    },

    toggleTpSlManual: () => {
        const check = document.getElementById('use-tpsl');
        // Just toggle visibility based on current checked state when clicked via header
        check.checked = !check.checked; 
        App.updateTpSlUI();
    },
    
    toggleTpSl: () => {
        // Triggered by actual checkbox change (stops propagation in HTML)
        App.updateTpSlUI();
    },

    toggleScanOpt: () => {
        const check = document.getElementById('scan-tpsl-opt');
        check.checked = !check.checked;
    },

    updateTpSlUI: () => {
        const check = document.getElementById('use-tpsl');
        document.getElementById('tpsl-params').classList.toggle('active', check.checked);
    },

    sTab: (id) => { document.querySelectorAll('.st-tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.sidebar-content').forEach(x=>x.classList.remove('active')); document.querySelector(`.st-tab[onclick="App.sTab('${id}')"]`).classList.add('active'); document.getElementById(`sb-${id}`).classList.add('active'); },
    updateHeaders: () => { const symFull = App.safeVal('symbol'); const sym = symFull.split('|')[0].trim(); const int = App.safeVal('interval'); const mTab = document.getElementById('tab-head-market'); if(mTab && sym) mTab.innerText = `${sym} (${int})`; const strat = App.safeVal('strategy'); const sTab = document.getElementById('tab-head-strat'); if(sTab && strat) { let pVals = []; App.paramsDef[strat].forEach(p => { const el = document.getElementById(p.id); if(el) pVals.push(el.value); }); sTab.innerText = `${strat.charAt(0).toUpperCase() + strat.slice(1)} [${pVals.join(', ')}]`; } },
    loadSyms:()=>{ const mEl = document.getElementById('market'); const sEl = document.getElementById('symbol'); if(!mEl || !sEl) return; const m = mEl.value; sEl.innerHTML=''; ASSETS[m].forEach(x=>{let o=document.createElement('option');o.value=x.s;o.text=`${x.s} | ${x.n}`;sEl.add(o)}); },
    renderUI:()=>{ const s = App.safeVal('strategy'); const c = document.getElementById('params'); if(!c || !s) return; c.innerHTML=''; App.paramsDef[s].forEach(p=>{c.innerHTML+=`<div><label>${p.l}</label><input type="number" id="${p.id}" value="${p.v}" step="${p.s||1}" onchange="App.updateHeaders()"></div>`}); App.updateHeaders(); },
    setTimer:()=>{ if(App.intervalId) clearInterval(App.intervalId); const el = document.getElementById('refresh'); if(!el) return; const ms = parseInt(el.value); if(ms > 0) App.intervalId=setInterval(()=>App.run(true), ms); },
    switchTab:(t)=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); const tabEl = document.querySelector(`.tab[onclick="App.switchTab('${t}')"]`); const contentEl = document.getElementById(`tab-${t}`); if(tabEl) tabEl.classList.add('active'); if(contentEl) contentEl.classList.add('active'); },
    toast:(m,t)=>{ const el=document.getElementById('toast'); if(!el) return; el.innerText=m;el.style.color=t==='green'?'#3fb950':'#ff7b72';el.style.display='block'; setTimeout(()=>el.style.display='none',3000); },
    modal:(s,t,d,p)=>{ const m=document.getElementById('loading-overlay'); if(!m) return; if(s){ m.style.display='flex'; document.getElementById('modal-title').innerText=t; document.getElementById('modal-desc').innerText=d; document.getElementById('modal-bar').style.width=p+'%'; document.getElementById('modal-percent').innerText=Math.round(p)+'%'; }else{m.style.display='none'} },

    fetchWithProxy: async (url, idx=0) => {
        if(idx >= PROXIES.length) throw new Error("All proxies failed");
        try {
            const r = await fetch(PROXIES[idx] + encodeURIComponent(url));
            if(!r.ok) throw new Error("Net Err");
            const raw = await r.json();
            return raw.contents ? JSON.parse(raw.contents) : raw;
        } catch(e) {
            return App.fetchWithProxy(url, idx+1);
        }
    },

    fetchData:async(so)=>{
        const m=App.safeVal('market'), s=so||App.safeVal('symbol'), t=App.safeVal('interval'), l=App.safeVal('limit');
        try{
            if(m==='CRYPTO'){
                let al=parseInt(l)>1000?1000:l;
                try {
                    const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=${t}&limit=${al}`);
                    if(!r.ok) throw new Error("Binance Direct Failed");
                    const j=await r.json();
                    return j.map(d=>({time:d[0]/1000,open:+d[1],high:+d[2],low:+d[3],close:+d[4],value:+d[5],color:(+d[4]>=+d[1]?'rgba(46,160,67,0.3)':'rgba(218,54,51,0.3)')}));
                } catch(err) {
                    const u = `https://api.binance.com/api/v3/klines?symbol=${s}&interval=${t}&limit=${al}`;
                    const j = await App.fetchWithProxy(u); 
                    if(j.code) throw new Error(j.msg);
                    return j.map(d=>({time:d[0]/1000,open:+d[1],high:+d[2],low:+d[3],close:+d[4],value:+d[5],color:(+d[4]>=+d[1]?'rgba(46,160,67,0.3)':'rgba(218,54,51,0.3)')}));
                }
            }else{
                let iv='1d',rg='1y';if(t==='15m'){rg='1mo';iv='15m'}else if(t==='1h'||t==='2h'||t==='4h'){rg='6mo';iv='60m'}
                const u=`https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=${iv}&range=${rg}`;
                const j = await App.fetchWithProxy(u);
                const res=j.chart.result[0],q=res.indicators.quote[0],ts=res.timestamp;
                let d=[];for(let i=0;i<ts.length;i++){if(q.open[i]===null)continue;let o=q.open[i],c=q.close[i];d.push({time:ts[i],open:o,high:q.high[i],low:q.low[i],close:c,value:q.volume[i]||0,color:(c>=o?'rgba(46,160,67,0.3)':'rgba(218,54,51,0.3)')})}
                return d.slice(-parseInt(l));
            }
        }catch(e){console.warn("Fetch failed, using sim"); return App.genSim(l)}
    },
    genSim:(l)=>{let d=[],t=Math.floor(Date.now()/1000)-(l*3600),p=100;for(let i=0;i<l;i++){let m=(Math.sin(i)*3),c=p+m,o=p;d.push({time:t,open:o,high:Math.max(o,c)+1,low:Math.min(o,c)-1,close:c,value:1000,color:'rgba(46,160,67,0.3)'});p=c;t+=3600}return d},

    run:async(sil=false)=>{
        if(!sil)App.modal(true,'Analiz','Veriler i≈üleniyor...',100);
        const sVal=App.safeVal('symbol'); 
        const d=await App.fetchData(sVal); 
        if(!d||!d.length){if(!sil)App.modal(false);return}
        App.data=d;
        
        const s=App.safeVal('strategy'); const p={};
        if(App.paramsDef[s]) App.paramsDef[s].forEach(k=>{const el=document.getElementById(k.id); if(el) p[k.id]=parseFloat(el.value)});
        
        // TPSL
        const useTpSl = document.getElementById('use-tpsl').checked;
        const tpVal = parseFloat(App.safeVal('tp-val'));
        const slVal = parseFloat(App.safeVal('sl-val'));

        const res=Logic.backtest(d,s,p, useTpSl, tpVal, slVal);
        
        App.cSeries.setData(d); App.vSeries.setData(d.map(x=>({time:x.time,value:x.value,color:x.color})));
        const rsiLen = parseInt(App.safeVal('vis-rsi-len')) || 14; App.rsiSeries.setData(Indicators.rsi(d, rsiLen));
        const markers = res.markers.map(m => ({...m, text: `${m.text} @ ${m.price ? m.price.toFixed(2) : ''}`}));
        App.cSeries.setMarkers(markers);
        if(!sil)App.chart.timeScale().fitContent();

        const bal=parseFloat(App.safeVal('balance'));
        const balEl = document.getElementById('res-bal'); if(balEl) balEl.innerText='$'+(bal+res.pnl).toFixed(2);
        const pnlEl = document.getElementById('res-pnl'); if(pnlEl) pnlEl.innerHTML=`<span class="${res.pnl>=0?'green':'red'}">${res.pnl.toFixed(2)}</span>`;
        const winEl = document.getElementById('res-win'); if(winEl) winEl.innerText='%'+res.winRate;
        const trEl = document.getElementById('res-trades'); if(trEl) trEl.innerText=res.trades.length;

        const tb=document.querySelector('#t-history tbody');
        if(tb) {
            tb.innerHTML='';
            [...res.trades].reverse().forEach(t=>{
                tb.innerHTML+=`<tr><td><span class="badge ${t.type==='LONG'?'b-long':'b-short'}">${t.type}</span></td><td>${new Date(t.et*1000).toLocaleString()}</td><td>${t.ep.toFixed(2)}</td><td>${new Date(t.xt*1000).toLocaleString()}</td><td>${t.xp.toFixed(2)}</td><td class="${t.pnl>=0?'green':'red'}">${t.pnl.toFixed(2)}</td><td style="font-size:0.7rem">${t.reason}</td></tr>`;
            });
        }

        const ab = document.getElementById('trade-status-bar');
        if(ab) {
            if(res.openPos) {
                ab.style.display = 'flex';
                const cur = d[d.length-1].close;
                const opnl = (res.openPos.type==='LONG'?cur-res.openPos.p:res.openPos.p-cur)*res.openPos.amt;
                document.getElementById('at-type').innerText = res.openPos.type;
                document.getElementById('at-type').className = `badge ${res.openPos.type==='LONG'?'b-long':'b-short'}`;
                document.getElementById('at-entry').innerText = res.openPos.p.toFixed(2);
                document.getElementById('at-curr').innerText = cur.toFixed(2);
                document.getElementById('at-pnl').innerText = `${opnl>=0?'+':''}${opnl.toFixed(2)} $`;
                document.getElementById('at-pnl').className = `ts-val ${opnl>=0?'green':'red'}`;
            } else { ab.style.display = 'none'; }
        }
        App.updateHeaders(); if(!sil)App.modal(false);
    }
};

// Safe Start
if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', App.init); } else { App.init(); }
</script>
</body>
</html>
